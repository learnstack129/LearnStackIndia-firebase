<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnStackIndia - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        accent: '#f59e0b',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'bounce-gentle': 'bounceGentle 2s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        .shape:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .shape:nth-child(2) {
            top: 20%;
            right: 10%;
            animation-delay: 2s;
        }

        .shape:nth-child(3) {
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
        }

        .shape:nth-child(4) {
            bottom: 10%;
            right: 15%;
            animation-delay: 1s;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-effect {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .dark .card-hover:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .dark .neon-glow {
            box-shadow: 0 0 20px rgba(147, 197, 253, 0.3);
        }

        .topic-icon {
            transition: all 0.3s ease;
        }

        .card-hover:hover .topic-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .progress-ring {
            transition: stroke-dasharray 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            pointer-events: none;
            animation: floatParticle 20s infinite linear;
        }

        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .hero-text {
            background: linear-gradient(135deg, #ccccd9 0%, #be8eef 50%, #eca2ec 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .text-6xl {
            line-height: 1.2;
        }

        .text-4xl {
            line-height: 1.2;
        }


        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
            border: 1px solid rgba(147, 197, 253, 0.3);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .algorithm-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .algorithm-card:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .dark .algorithm-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 640px) {
            #welcomeText {
                display: none;
            }
        }

        /* --- NEW: Doubt Modal Styles --- */
        .modal {
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
        }

        .modal-content-anim {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 60vh;
            /* Fixed height for chat */
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f1f5f9;
            /* bg-gray-100 */
            border: 1px solid #e2e8f0;
            /* border-gray-200 */
            border-radius: 0.5rem;
            /* rounded-lg */
        }

        .dark .chat-messages {
            background-color: #1f2937;
            /* dark:bg-gray-800 */
            border-color: #334155;
            /* dark:border-gray-700 */
        }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 80%;
        }

        .chat-message.user {
            margin-left: auto;
            text-align: right;
        }

        .chat-message.mentor {
            margin-right: auto;
            text-align: left;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            /* rounded-xl */
            display: inline-block;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-message.user .message-bubble {
            background-color: #2563eb;
            /* bg-blue-600 */
            color: #ffffff;
            /* text-white */
            border-bottom-right-radius: 0.25rem;
        }

        .dark .chat-message.user .message-bubble {
            background-color: #2563eb;
            color: #ffffff;
        }

        .chat-message.mentor .message-bubble {
            background-color: #e5e7eb;
            /* bg-gray-200 */
            color: #1f2937;
            /* text-gray-800 */
            border-bottom-left-radius: 0.25rem;
        }

        .dark .chat-message.mentor .message-bubble {
            background-color: #4b5563;
            /* dark:bg-gray-600 */
            color: #f3f4f6;
            /* dark:text-gray-100 */
        }

        .message-sender {
            font-size: 0.75rem;
            /* text-xs */
            font-weight: 600;
            color: #6b7280;
            /* text-gray-500 */
            margin-bottom: 0.25rem;
        }

        .dark .message-sender {
            color: #9ca3af;
            /* dark:text-gray-400 */
        }

        .chat-input-area {
            display: flex;
            gap: 0.75rem;
            /* space-x-3 */
            margin-top: 1rem;
        }

        .chat-input {
            flex-grow: 1;
        }

        .input-field {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #111827;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s;
            width: 100%;
        }

        .dark .input-field {
            border-color: #4b5563;
            background-color: #374151;
            color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .btn-primary {
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            color: #111827;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }

        .dark .btn-secondary {
            background-color: #4b5563;
            color: #f9fafb;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .dark .btn-secondary:hover {
            background-color: #6b7280;
        }

        #globalAlert button {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* --- End Doubt Modal Styles --- */
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 min-h-screen">
    <div class="floating-particles">
    </div>

    <nav class="bg-white dark:bg-gray-800 shadow-xl relative z-10 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div
                        class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        <i class="fas fa-code mr-2 text-blue-600"></i>
                        LearnStackIndia
                    </div>
                </div>

                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="themeToggle"
                        class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 neon-glow">
                        <i id="themeIcon" class="fas fa-moon text-lg"></i>
                    </button>

                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div class="flex items-center space-x-2">
                            <div
                                class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                <span id="userInitial">U</span>
                            </div>
                            <span id="welcomeText"
                                class="hidden sm:block text-gray-700 dark:text-gray-300 font-semibold truncate">Loading...</span>
                        </div>
                        <button id="logoutBtn"
                            class="bg-red-500 text-white px-2 py-2 sm:px-4 rounded-lg hover:bg-red-600 transition-all duration-300 shadow-lg hover:shadow-red-500/25 font-medium">
                            <i class="fas fa-sign-out-alt sm:mr-1"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="relative z-10">
        <section class="gradient-bg text-white py-16 sm:py-20 relative overflow-hidden">
            <div class="floating-shapes">
                <div class="shape w-32 h-32 bg-white rounded-full"></div>
                <div class="shape w-24 h-24 bg-blue-200 rounded-lg transform rotate-45"></div>
                <div class="shape w-20 h-20 bg-purple-200 rounded-full"></div>
                <div class="shape w-28 h-28 bg-pink-200 rounded-lg transform rotate-12"></div>
            </div>

            <div class="absolute inset-0 bg-black opacity-10"></div>
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl sm:text-6xl font-bold animate-fade-in hero-text" style="padding-bottom: 1.5rem;">
                    Master Programming Subjects
                </h1>
                <p class="text-lg sm:text-xl mb-8 max-w-3xl mx-auto animate-slide-up opacity-90">
                    Interactive visualizations and step-by-step learning to help you understand complex subjects
                </p>
                <div
                    class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 animate-slide-up">
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold" id="totalSubjects">
                            <span class="loading-skeleton w-8 h-8 rounded inline-block"></span>
                        </div>
                        <div class="text-sm opacity-80">Subjects Available</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold" id="totalTopics">
                            <span class="loading-skeleton w-8 h-8 rounded inline-block"></span>
                        </div>
                        <div class="text-sm opacity-80">Topics Available</div>
                    </div>
                    <div class="stats-card p-4 rounded-xl backdrop-blur-sm">
                        <div class="text-2xl font-bold" id="totalAlgorithms">
                            <span class="loading-skeleton w-8 h-8 rounded inline-block"></span>
                        </div>
                        <div class="text-sm opacity-80">Algorithms</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8 bg-gray-100 dark:bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Overall Progress</p>
                                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="learningProgress">
                                    <span class="loading-skeleton w-12 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div class="relative">
                                <svg class="w-12 h-12" id="progressRing">
                                    <circle cx="24" cy="24" r="20" fill="transparent" stroke="#e5e7eb" stroke-width="4">
                                    </circle>
                                    <circle cx="24" cy="24" r="20" fill="transparent" stroke="#3b82f6" stroke-width="4"
                                        stroke-dasharray="125.6" stroke-dashoffset="125.6" class="progress-ring"
                                        id="progressCircle"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <i class="fas fa-chart-line text-blue-600 text-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Algos Completed</p>
                                <p class="text-2xl font-bold text-green-600 dark:text-green-400"
                                    id="algorithmsCompleted">
                                    <span class="loading-skeleton w-8 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-trophy text-green-600 dark:text-green-400 text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Time Today</p>
                                <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="timeToday">
                                    <span class="loading-skeleton w-12 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-purple-600 dark:text-purple-400 text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Your Rank</p>
                                <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="currentRank">
                                    <span class="loading-skeleton w-16 h-6 rounded inline-block"></span>
                                </p>
                            </div>
                            <div
                                class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-medal text-orange-600 dark:text-orange-400 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="subjectsSection" class="py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white mb-4 animate-fade-in">
                    Explore Subjects
                </h2>
                <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto animate-slide-up">
                    Choose a subject to start learning
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="subjectsGrid">
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
                <div class="loading-skeleton rounded-xl h-48"></div>
            </div>
        </section>

        <section id="testSection" class="py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white mb-4 animate-fade-in">
                    Secure Tests
                </h2>
                <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto animate-slide-up">
                    Ready for a challenge? Select an active test to begin.
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="testsGrid">
                <div class="loading-skeleton rounded-xl h-40"></div>
                <div class="loading-skeleton rounded-xl h-40 hidden sm:block"></div>
                <div class="loading-skeleton rounded-xl h-40 hidden lg:block"></div>
            </div>
        </section>

        <section id="topicsSection" class="hidden py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12 gap-4">
                <h2 id="topicListTitle"
                    class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white animate-fade-in">
                    Topics
                </h2>
                <button id="backToSubjectsBtn"
                    class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 font-medium self-start sm:self-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Subjects
                </button>
                <button id="askDoubtBtn"
                    class="hidden btn-primary bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors duration-300 font-medium self-start sm:self-center">
                    <i class="fas fa-comments mr-2"></i>Ask a Doubt
                </button>
            </div>

            <div id="dailyChallengeContainer" class="mb-8">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="topicsGrid">
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
            </div>
        </section>
        <section id="algorithmsSection" class="hidden py-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-12 gap-4">
                <h2 id="algorithmListTitle"
                    class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white animate-fade-in">
                    Algorithms
                </h2>
                <button id="backToTopicsBtn"
                    class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 font-medium self-start sm:self-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Topics
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="algorithmsGrid">
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
                <div class="loading-skeleton rounded-xl h-32"></div>
            </div>
        </section>

        <section class="py-16 bg-gray-100 dark:bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h3 class="text-3xl font-bold text-gray-800 dark:text-white mb-8 animate-fade-in">
                    Ready to Continue Learning?
                </h3>
                <div class="flex flex-col sm:flex-row flex-wrap justify-center gap-4">
                    <button id="randomChallenge"
                        class="w-full sm:w-auto bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-green-500/25 hover:scale-105 transition-all duration-300 animate-fade-in">
                        <i class="fas fa-random mr-2"></i>
                        Random Challenge
                    </button>
                    <button id="viewProgress"
                        class="w-full sm:w-auto bg-gradient-to-r from-purple-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-purple-500/25 hover:scale-105 transition-all duration-300 animate-fade-in">
                        <i class="fas fa-chart-line mr-2"></i>
                        View Progress
                    </button>
                </div>
            </div>
        </section>
    </main>



    <div id="doubtModal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-2xl bg-white dark:bg-gray-800 modal-content-anim">

            <div id="doubtListContainer">
                <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">My Doubts</h3>
                    <button onclick="closeDoubtModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-times text-2xl"></i></button>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="showCreateDoubtForm()" class="btn-primary bg-green-500 hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Ask a New Doubt
                    </button>
                </div>
                <div id="doubtList" class="max-h-[60vh] overflow-y-auto space-y-3 p-1">
                    <div class="loading-skeleton h-16 w-full rounded-lg"></div>
                    <div class="loading-skeleton h-16 w-full rounded-lg"></div>
                </div>
            </div>

            <div id="doubtCreateContainer" class="hidden">
                <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Ask a New Doubt</h3>
                    <button onclick="showDoubtList()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-arrow-left text-2xl"></i></button>
                </div>
                <form id="newDoubtForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="doubtSubjectSelect"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject*</label>
                            <select id="doubtSubjectSelect" class="input-field" required>
                                <option value="" disabled selected>Select a subject...</option>
                            </select>
                        </div>
                        <div>
                            <label for="doubtTopicSelect"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Topic*</label>
                            <select id="doubtTopicSelect" class="input-field" required disabled>
                                <option value="" disabled selected>Select a topic...</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="doubtInitialQuestion"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your
                            Question*</label>
                        <textarea id="doubtInitialQuestion" class="input-field" rows="6"
                            placeholder="Be specific! What did you try? What error are you getting?"
                            required></textarea>
                    </div>
                    <p id="newDoubtError" class="text-red-500 text-sm h-4"></p>
                    <div class="text-right">
                        <button type="submit" id="submitNewDoubtBtn" class="btn-primary">
                            <span id="submitDoubtBtnText">Submit Doubt</span>
                            <span id="submitDoubtBtnSpinner" class="hidden"><i
                                    class="fas fa-spinner fa-spin mr-2"></i>Submitting...</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="doubtChatContainer" class="hidden">
                <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white" id="doubtChatTitle">Loading...</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="doubtChatSubject"></p>
                    </div>
                    <button onclick="showDoubtList()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-arrow-left text-2xl"></i></button>
                </div>

                <input type="hidden" id="currentUserChatThreadId">
                <div id="userChatLoading" class="text-center p-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                </div>

                <div id="userChatArea" class="chat-container hidden">
                    <div id="userChatMessages" class="chat-messages">
                    </div>
                    <div class="chat-input-area">
                        <textarea id="userReplyMessage" class="input-field chat-input" placeholder="Type your reply..."
                            rows="3"></textarea>
                        <button id="sendUserReplyBtn" class="btn-primary self-end" onclick="sendUserReply()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button id="userResolveDoubtBtn" type="button" class="btn-primary bg-green-500 hover:bg-green-600"
                        onclick="resolveUserThread()">
                        <i class="fas fa-check-circle mr-2"></i>Mark as Resolved
                    </button>
                </div>
            </div>

        </div>
    </div>
    <div id="globalAlert"
        class="fixed bottom-5 right-5 z-[100] hidden max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0">
        <p id="globalAlertMessage" class="mr-4"></p>
        <button onclick="hideGlobalAlert()" aria-label="Close alert">&times;</button>
    </div>



    <script>
        // Application state
        let currentUser = null;
        let dashboardData = null;
        let currentTopicsArray = []; // Store topics for the "back" button

        // API Configuration
        const API_BASE_URL = '/api';

        // Utility function to get auth token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // API call with authentication
        async function makeAuthenticatedAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                redirectToAuth();
                throw new Error("Authentication token not found.");
            }
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    },
                    ...options
                });
                clearTimeout(timeoutId);
                if (response.status === 401) {
                    redirectToAuth();
                    throw new Error("Authentication failed (401).");
                }
                const contentType = response.headers.get("content-type");
                let data;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { success: response.ok, message: text || `HTTP ${response.status}` };
                }
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('Request timeout. Please check your connection.', 'error');
                } else if (!error.message.includes("Authentication failed")) {
                    showAlert(`API Error: ${error.message}`, 'error');
                }
                throw error;
            }
        }

        // --- NEW: API Helper for /api/doubts ---
        async function makeDoubtAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                redirectToAuth();
                throw new Error("Authentication token not found.");
            }
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    },
                    ...options
                });
                clearTimeout(timeoutId);
                if (response.status === 401) {
                    redirectToAuth();
                    throw new Error("Authentication failed (401).");
                }
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('Request timeout. Please check your connection.', 'error');
                } else if (!error.message.includes("Authentication failed")) {
                    showAlert(`Doubt API Error: ${error.message}`, 'error');
                }
                throw error;
            }
        }
        // --- END NEW HELPER ---

        // Theme Management
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            let currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme);
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                localStorage.setItem('theme', currentTheme);
            });
            function applyTheme(theme) {
                html.classList.toggle('dark', theme === 'dark');
                themeIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'} text-lg`;
            }
        }

        // Initialize user data from localStorage
        function initializeUser() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}`;
                    document.getElementById('userInitial').textContent = currentUser.username.charAt(0).toUpperCase();
                } catch (error) {
                    redirectToAuth();
                }
            } else {
                redirectToAuth();
            }
        }

        // Fetch dashboard data
        async function loadDashboardData() {
            showSkeletonLoaders();
            try {
                console.log('üîÑ Fetching dashboard data...');
                dashboardData = await makeAuthenticatedAPICall('/auth/dashboard');
                if (dashboardData) {
                    console.log('‚úÖ Dashboard data loaded:', dashboardData);
                    updateDashboardUI(dashboardData);
                } else {
                    showEmptyDashboard();
                }
            } catch (error) {
                console.error('‚ùå Critical error loading dashboard:', error);
                showEmptyDashboard();
            }
        }

        // Show loading skeletons
        function showSkeletonLoaders() {
            // Hero Stats
            document.getElementById('totalSubjects').innerHTML = `<span class="loading-skeleton w-8 h-8 rounded inline-block"></span>`;
            document.getElementById('totalTopics').innerHTML = `<span class="loading-skeleton w-8 h-8 rounded inline-block"></span>`;
            document.getElementById('totalAlgorithms').innerHTML = `<span class="loading-skeleton w-8 h-8 rounded inline-block"></span>`;

            // Personal Stats
            document.getElementById('learningProgress').innerHTML = `<span class="loading-skeleton w-12 h-6 rounded inline-block"></span>`;
            document.getElementById('algorithmsCompleted').innerHTML = `<span class="loading-skeleton w-8 h-6 rounded inline-block"></span>`;
            document.getElementById('timeToday').innerHTML = `<span class="loading-skeleton w-12 h-6 rounded inline-block"></span>`;
            document.getElementById('currentRank').innerHTML = `<span class="loading-skeleton w-16 h-6 rounded inline-block"></span>`;
            updateProgressRing(0);

            // Subjects
            showDefaultSubjects();

            // --- ADD THIS ---
            // Tests
            const testGrid = document.getElementById('testsGrid');
            if (testGrid) {
                testGrid.innerHTML = `
                    <div class="loading-skeleton rounded-xl h-40"></div>
                    <div class="loading-skeleton rounded-xl h-40 hidden sm:block"></div>
                    <div class="loading-skeleton rounded-xl h-40 hidden lg:block"></div>`;
            }
        }

        // Update UI with real data
        function updateDashboardUI(data) {
            const stats = data?.stats || {};
            const user = data?.user || {};
            const rank = stats.rank || {};
            const subjectsData = data?.subjects || {}; // Use subjects data

            document.getElementById('welcomeText').textContent = `Welcome, ${user.username || 'User'}`;
            document.getElementById('userInitial').textContent = (user.username || 'U').charAt(0).toUpperCase();

            // Personal Stats
            document.getElementById('learningProgress').textContent = `${stats.overallProgress ?? 0}%`;
            document.getElementById('algorithmsCompleted').textContent = stats.algorithmsCompleted ?? 0;
            document.getElementById('timeToday').textContent = formatTime(stats.timeToday ?? 0);
            document.getElementById('currentRank').textContent = rank.level ?? 'Bronze';

            // Hero Stats
            const totalAlgoCount = stats.totalAlgorithms ?? '?';
            const totalTopicCount = Object.values(subjectsData).reduce((acc, subject) => acc + (subject.topics ? subject.topics.length : 0), 0) || '?';
            const totalSubjectCount = Object.keys(subjectsData).length > 0 ? Object.keys(subjectsData).length : '?';

            document.getElementById('totalSubjects').textContent = totalSubjectCount;
            document.getElementById('totalTopics').textContent = totalTopicCount;
            document.getElementById('totalAlgorithms').textContent = totalAlgoCount;

            updateProgressRing(stats.overallProgress ?? 0);

            // Update subjects grid
            updateSubjectsGrid(subjectsData);

            // --- ADD THIS ---
            loadActiveTests(); // Fetch and render active tests
        }

        // Show empty/default dashboard
        function showEmptyDashboard() {
            // Hero
            document.getElementById('totalSubjects').textContent = '0';
            document.getElementById('totalTopics').textContent = '0';
            document.getElementById('totalAlgorithms').textContent = '0';
            // Personal
            document.getElementById('learningProgress').textContent = '0%';
            document.getElementById('algorithmsCompleted').textContent = '0';
            document.getElementById('timeToday').textContent = '0m';
            document.getElementById('currentRank').textContent = 'Bronze';
            updateProgressRing(0);
            showDefaultSubjects();

            // --- ADD THIS ---
            const testGrid = document.getElementById('testsGrid');
            if (testGrid) testGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No active tests are available.</p>';
        }

        // Format time helper
        function formatTime(minutes) {
            if (minutes === 0 || minutes === undefined || minutes === null) return '0m';
            if (minutes < 60) return `${Math.round(minutes)}m`;
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }

        // Update progress ring
        function updateProgressRing(percentage) {
            const circle = document.getElementById('progressCircle');
            if (!circle) return;
            const radius = circle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const validPercentage = Math.max(0, Math.min(100, percentage || 0));
            const offset = circumference - (validPercentage / 100 * circumference);
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            setTimeout(() => { circle.style.strokeDashoffset = offset; }, 50);
        }

        // --- LEVEL 1: SUBJECTS ---

        function showDefaultSubjects() {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = `<div class="loading-skeleton rounded-xl h-48"></div>`.repeat(4);
        }

        function updateSubjectsGrid(subjects) {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '';

            // The 'subjects' object is now { "SubjectName": { icon, color, topics: [...] } }
            const subjectNames = Object.keys(subjects);

            if (subjectNames.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No subjects available.</p>';
                return;
            }

            // Sort subject names alphabetically
            subjectNames.sort();

            subjectNames.forEach(subjectName => {
                const subjectData = subjects[subjectName]; // This is { icon, color, topics }
                // Pass the whole subjectData object to the card creator
                const card = createSubjectCard(subjectName, subjectData);
                grid.appendChild(card);
            });
        }

        function createSubjectCard(subjectName, subjectData) {
            const div = document.createElement('div');

            // --- THIS IS THE NEW LOGIC ---
            // We get icon, color, and topics from the subjectData object
            const topicsArray = subjectData.topics || [];
            const topicIcon = subjectData.icon || 'book';
            const topicColor = subjectData.color || 'gray';
            // --- END NEW LOGIC ---

            const topicCount = topicsArray.length;

            let totalCompletion = 0;
            topicsArray.forEach(topic => {
                totalCompletion += (topic.completion || 0);
            });

            const subjectCompletion = topicCount > 0 ? Math.round(totalCompletion / topicCount) : 0;

            const isSubjectCompleted = topicCount > 0 && topicsArray.every(t => t.status === 'completed');
            const isSubjectInProgress = !isSubjectCompleted && topicsArray.some(t => t.status === 'in-progress' || t.status === 'completed');

            let status, statusInfo;
            if (isSubjectCompleted) status = 'completed';
            else if (isSubjectInProgress) status = 'in-progress';
            else if (topicCount === 0) status = 'available'; // Empty subjects are just 'Available'
            else status = 'available';

            statusInfo = getStatusInfo(status);

            div.className = `card-hover bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 animate-fade-in group cursor-pointer`;

            // The HTML is the same, but now uses the correct variables
            div.innerHTML = `
                <div class="text-center mb-4 relative">
                    <div class="w-16 h-16 bg-${topicColor}-100 dark:bg-${topicColor}-900 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-${topicIcon} text-2xl text-${topicColor}-600 dark:text-${topicColor}-400 topic-icon"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-1">${subjectName}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${topicCount} ${topicCount === 1 ? 'Topic' : 'Topics'}</p>
                    ${subjectCompletion > 0 ? `<p class="text-xs text-gray-600 dark:text-gray-300 mt-1">${subjectCompletion}% Complete</p>` : ''}
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusInfo.class}">
                        <i class="fas ${statusInfo.icon} mr-1"></i>
                        ${statusInfo.text}
                    </div>
                </div>
            `;

            // The click handler now just passes the topics array
            div.addEventListener('click', () => handleSubjectClick(subjectName, topicsArray));
            return div;
        }

        function handleSubjectClick(subjectName, topicsArray) {
            console.log("Subject clicked:", subjectName);
            currentTopicsArray = topicsArray; // This is already the correct topics array
            showTopicsList(subjectName, topicsArray);
        }

        function showSubjectsView() {
            document.getElementById('subjectsSection').classList.remove('hidden');
            document.getElementById('testSection').classList.remove('hidden'); // <-- CORRECTED ID
            document.getElementById('topicsSection').classList.add('hidden');
            document.getElementById('algorithmsSection').classList.add('hidden');
            
            // --- NEW: Hide doubt button ---
            document.getElementById('askDoubtBtn').classList.add('hidden');
        }

        // --- NEW: Test Section Functions ---

        async function loadActiveTests() {
            const grid = document.getElementById('testsGrid');
            grid.innerHTML = `
                <div class="loading-skeleton rounded-xl h-40"></div>
                <div class="loading-skeleton rounded-xl h-40 hidden sm:block"></div>
                <div class="loading-skeleton rounded-xl h-40 hidden lg:block"></div>`;

            try {
                // This endpoint was added to backend/routes/test.js
                const data = await makeAuthenticatedAPICall('/test/active');

                grid.innerHTML = ''; // Clear skeletons
                if (data && data.success && data.tests) {
                    if (data.tests.length === 0) {
                        grid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No active tests are available at this time.</p>';
                        return;
                    }
                    // Get the user's attempts from the main dashboardData object
                    const userAttempts = dashboardData?.user?.testAttempts || [];

                    data.tests.forEach(test => {
                        // Find if the user has an attempt for this test
                        const attempt = userAttempts.find(a => a.testId === test._id);
                        const card = createTestCard(test, attempt); // <-- Pass the attempt (or undefined)
                        grid.appendChild(card);
                    });
                } else {
                    throw new Error(data.message || 'Failed to load tests.');
                }
            } catch (error) {
                console.error('Error loading active tests:', error);
                grid.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full">${error.message}</p>`;
            }
        }

        function createTestCard(test, attempt) { // <-- Added 'attempt'
            const div = document.createElement('div');

            let statusText, statusClass, statusIcon, isLocked;

            if (attempt?.status === 'completed') {
                statusText = 'Completed';
                statusClass = 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300';
                statusIcon = 'fa-check-circle';
                isLocked = true;
            } else if (attempt?.status === 'locked') {
                statusText = 'Locked';
                statusClass = 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
                statusIcon = 'fa-lock';
                isLocked = true;
            } else if (attempt?.status === 'inprogress') {
                statusText = 'In Progress';
                statusClass = 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300';
                statusIcon = 'fa-play-circle'; // Or 'fa-hourglass-half'
                isLocked = false; // Allow re-entry
            } else {
                statusText = 'Start Test';
                statusClass = 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 group-hover:bg-green-200 dark:group-hover:bg-green-800'; // Add hover effect
                statusIcon = 'fa-play-circle';
                isLocked = false;
            }

            // Added flex flex-col justify-between to make footer stick to bottom
            div.className = `card-hover bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 animate-fade-in group flex flex-col justify-between ${isLocked ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}`;

            div.innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-stopwatch text-2xl text-indigo-600 dark:text-indigo-400 topic-icon"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">${test.title}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Mentor: ${test.createdBy?.username || 'N/A'}</p>
                </div>
                <div class="mt-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass} transition-colors">
                        <i class="fas ${statusIcon} mr-2"></i>
                        ${statusText}
                    </span>
                </div>
            `;

            if (!isLocked) { // Only add click listener if not completed or locked
                div.addEventListener('click', () => {
                    // Redirect to the test player with the correct testId
                    window.location.href = `test_player.html?testId=${test._id}`;
                });
            } else {
                div.setAttribute('title', `You have already ${attempt.status} this test.`);
            }
            return div;
        }

        // --- LEVEL 2: TOPICS ---

        // *** 2. MODIFIED THIS FUNCTION ***
        async function showTopicsList(subjectName, topicsArray) {
            const topicsSection = document.getElementById('topicsSection');
            const subjectsSection = document.getElementById('subjectsSection');
            const algorithmsSection = document.getElementById('algorithmsSection');
            const topicsGrid = document.getElementById('topicsGrid');
            const topicListTitle = document.getElementById('topicListTitle');
            const testSection = document.getElementById('testSection'); // <-- CORRECTED ID
            
            const dailyChallengeContainer = document.getElementById('dailyChallengeContainer');
            dailyChallengeContainer.innerHTML = `<div class="loading-skeleton h-24 rounded-xl"></div>`; 

            // --- NEW: Subject Access Check & Button Toggle ---
            const askDoubtBtn = document.getElementById('askDoubtBtn');
            // Check if *any* topic in the array is not locked
            const isSubjectAccessible = topicsArray.some(topic => topic.status !== 'locked');
            
            if (isSubjectAccessible) {
                askDoubtBtn.classList.remove('hidden');
                // Store current subject/topics for the modal
                askDoubtBtn.dataset.subjectName = subjectName; 
                askDoubtBtn.dataset.topics = JSON.stringify(topicsArray.map(t => ({id: t.id, name: t.name})));
            } else {
                askDoubtBtn.classList.add('hidden');
            }
            // --- END NEW ---

            async function loadDailyChallenge() {
                try {
                    const data = await makeAuthenticatedAPICall(`/daily-problem/active/${encodeURIComponent(subjectName)}`);
                    if (data?.success && data.problem) {
                        dailyChallengeContainer.innerHTML = `
                            <div class="card-hover bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border-2 border-blue-500 dark:border-blue-400 animate-fade-in group cursor-pointer"
                                 onclick="window.location.href='daily_problem.html?problemId=${data.problem._id}'">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="block text-sm font-medium text-blue-600 dark:text-blue-400">Today's Challenge</span>
                                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mt-1">${data.problem.title}</h3>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white group-hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-pen-alt mr-2"></i> Start
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        dailyChallengeContainer.innerHTML = ''; // Hide if no problem
                    }
                } catch (error) {
                    console.error("Error fetching daily challenge:", error);
                    dailyChallengeContainer.innerHTML = ``; // Hide on error
                }
            }
            
            loadDailyChallenge(); 

            topicListTitle.textContent = `${subjectName} Topics`;
            topicsGrid.innerHTML = ''; 

            if (!topicsArray || topicsArray.length === 0) {
                topicsGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No topics found for this subject.</p>';
            } else {
                topicsArray.forEach(topic => {
                    const card = createTopicCard(topic);
                    topicsGrid.appendChild(card);
                });
            }

            subjectsSection.classList.add('hidden');
            testSection.classList.add('hidden'); // <-- CORRECTED ID
            algorithmsSection.classList.add('hidden');
            topicsSection.classList.remove('hidden');
        }

        function createTopicCard(topic) {
            const div = document.createElement('div');
            const isLocked = topic.status === 'locked';

            div.className = `algorithm-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md border border-gray-200 dark:border-gray-700 flex items-center justify-between animate-fade-in ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-lg hover:border-blue-300 dark:hover:border-blue-600'}`;

            const statusInfo = getStatusInfo(topic.status);
            const algoCount = topic.algorithms.length;

            div.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${topic.name}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${algoCount} ${algoCount === 1 ? 'Algorithm' : 'Algorithms'}</p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                        <i class="fas ${statusInfo.icon} mr-1"></i>
                        ${statusInfo.text}
                    </div>
                    ${topic.completion > 0 ? `<span class="text-xs text-blue-600 dark:text-blue-400 block mt-1">${topic.completion}%</span>` : ''}
                </div>
            `;

            if (!isLocked) {
                div.addEventListener('click', () => handleTopicClick(topic));
            } else {
                div.setAttribute('title', 'This topic is currently locked.');
            }
            return div;
        }

        function handleTopicClick(topic) {
            console.log("Topic clicked:", topic.id, "Status:", topic.status);
            if (topic.status === 'locked') {
                showAlert('This topic is locked. Complete prerequisites to unlock it!', 'warning');
            } else {
                showAlgorithmList(topic);
            }
        }

        function showTopicsView() {
            document.getElementById('subjectsSection').classList.add('hidden');
            document.getElementById('testSection').classList.add('hidden'); // <-- Hide test section
            document.getElementById('topicsSection').classList.remove('hidden');
            document.getElementById('algorithmsSection').classList.add('hidden');
        }

        // --- LEVEL 3: ALGORITHMS ---

        function showAlgorithmList(topic) {
            const topicsSection = document.getElementById('topicsSection');
            const algorithmsSection = document.getElementById('algorithmsSection');
            const algorithmsGrid = document.getElementById('algorithmsGrid');
            const algorithmListTitle = document.getElementById('algorithmListTitle');

            algorithmListTitle.textContent = `${topic.name} Algorithms`;
            algorithmsGrid.innerHTML = '';

            if (!topic.algorithms || topic.algorithms.length === 0) {
                algorithmsGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No algorithms found for this topic.</p>';
            } else {
                topic.algorithms.forEach(algoDef => {
                    const algoProgress = topic.userAlgoProgress[algoDef.id] || { completed: false, accuracyPractice: 0, attemptsPractice: 0 };
                    const card = createAlgorithmCard(topic, algoDef, algoProgress); // Pass the whole topic object
                    algorithmsGrid.appendChild(card);
                });
            }

            topicsSection.classList.add('hidden');
            algorithmsSection.classList.remove('hidden');
        }

        function createAlgorithmCard(topic, algoDef, algoProgress) {
            const div = document.createElement('div');
            const effectiveStatus = algoProgress.effectiveStatus || 'available';
            const isLocked = effectiveStatus === 'locked';

            div.className = `algorithm-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md border border-gray-200 dark:border-gray-700 flex items-center justify-between animate-fade-in ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-lg hover:border-blue-300 dark:hover:border-blue-600'}`;

            const isCompleted = algoProgress.completed === true;
            const statusIcon = isLocked
                ? '<i class="fas fa-lock text-red-500 ml-2" title="Locked"></i>'
                : (isCompleted
                    ? '<i class="fas fa-check-circle text-green-500 ml-2" title="Completed"></i>'
                    : '<i class="far fa-circle text-gray-400 ml-2" title="Not Completed"></i>');

            const attemptsPractice = algoProgress.attemptsPractice || 0;
            const accuracyPractice = algoProgress.accuracyPractice || 0;
            const accuracyText = attemptsPractice > 0 ? `<span class="text-xs text-blue-600 dark:text-blue-400">${accuracyPractice.toFixed(0)}%</span>` : '';

            div.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${algoDef.name} ${statusIcon}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${(algoDef.description || '').substring(0, 40)}...</p>
                </div>
                <div class="text-right">
                    <span class="text-xs font-medium px-2 py-0.5 rounded ${getDifficultyClass(algoDef.difficulty)}">${algoDef.difficulty}</span>
                    ${accuracyText}
                </div>
            `;

            if (!isLocked) {
                // Pass subject name, topic ID, and algorithm ID
                div.addEventListener('click', () => handleAlgorithmClick(topic.subject, topic.id, algoDef.id));
            } else {
                div.setAttribute('title', 'This algorithm is currently locked.');
            }
            return div;
        }

        function handleAlgorithmClick(subjectName, topicId, algorithmId) {

            const sanitize = (name) => {
                if (!name) return 'Uncategorized';
                return name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '');
            };

            const subjectFolder = sanitize(subjectName);
            const topicFolder = sanitize(topicId); // topicId is usually clean (e.g., "sorting")

            // Build the new path: e.g., "DSA_Visualizer/sorting/bubbleSort.html"
            const filePath = `${subjectFolder}/${topicFolder}/${algorithmId}.html`;

            console.log(`Navigating to: ${filePath}`);
            window.location.href = filePath;
        }


        // --- SHARED HELPER FUNCTIONS ---

        function getStatusInfo(status) {
            switch (status) {
                case 'available': return { class: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300', icon: 'fa-check', text: 'Available' };
                case 'in-progress': return { class: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300', icon: 'fa-hourglass-half', text: 'In Progress' };
                case 'completed': return { class: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300', icon: 'fa-trophy', text: 'Completed' };
                default: return { class: 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400', icon: 'fa-lock', text: 'Locked' };
            }
        }

        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case 'easy': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                case 'hard': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                case 'beginner': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                case 'intermediate': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                case 'advanced': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
            }
        }

        // --- REMOVED LEARNING PATH & ACHIEVEMENT FUNCTIONS ---

        // Show alert
        function showAlert(message, type = 'info') {
            alert(message); // Simple alert
        }

        // Redirect to auth page
        function redirectToAuth() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'auth.html';
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                redirectToAuth();
            }
        }

        function setButtonLoading(buttonId, textElementId, spinnerElementId, isLoading = true) {
            const button = document.getElementById(buttonId);
            const textElement = document.getElementById(textElementId);
            const spinnerElement = document.getElementById(spinnerElementId);

            if (isLoading) {
                button.disabled = true;
                textElement.classList.add('hidden');
                spinnerElement.classList.remove('hidden');
            } else {
                button.disabled = false;
                textElement.classList.remove('hidden');
                spinnerElement.classList.add('hidden');
            }
        }

        // Create floating particles
        function createParticles() {
            const particleContainer = document.querySelector('.floating-particles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 20 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.opacity = Math.random() * 0.1 + 0.05;
                particleContainer.appendChild(particle);
            }
        }

        // --- NEW: DOUBT MODAL FUNCTIONS ---

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.round(diffMs / 1000);
            const diffMinutes = Math.round(diffSeconds / 60);
            const diffHours = Math.round(diffMinutes / 60);
            const diffDays = Math.round(diffHours / 24);

            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return `Yesterday`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function openDoubtModal() {
            document.getElementById('doubtModal').classList.add('show');
            showDoubtList(); // Default to showing the list view
        }

        function closeDoubtModal() {
            document.getElementById('doubtModal').classList.remove('show');
        }

        function showDoubtList() {
            document.getElementById('doubtListContainer').classList.remove('hidden');
            document.getElementById('doubtCreateContainer').classList.add('hidden');
            document.getElementById('doubtChatContainer').classList.add('hidden');
            loadUserDoubts(); // Refresh the list every time it's shown
        }

        function showCreateDoubtForm() {
            document.getElementById('doubtListContainer').classList.add('hidden');
            document.getElementById('doubtCreateContainer').classList.remove('hidden');
            document.getElementById('doubtChatContainer').classList.add('hidden');

            // Populate the subject dropdown based on data we already have
            populateDoubtFormSubjects();

            // Pre-select the subject/topic if coming from the "Ask a Doubt" button
            const askDoubtBtn = document.getElementById('askDoubtBtn');
            const subjectName = askDoubtBtn.dataset.subjectName;
            if (subjectName) {
                const subjectSelect = document.getElementById('doubtSubjectSelect');
                subjectSelect.value = subjectName;
                handleDoubtSubjectChange(); // Trigger topic dropdown population
            }
        }

        function showDoubtChat(threadId) {
            document.getElementById('doubtListContainer').classList.add('hidden');
            document.getElementById('doubtCreateContainer').classList.add('hidden');
            document.getElementById('doubtChatContainer').classList.remove('hidden');

            document.getElementById('userChatArea').classList.add('hidden');
            document.getElementById('userChatLoading').classList.remove('hidden');

            openUserDoubtChat(threadId); // Fetch and display the chat
        }

        async function loadUserDoubts() {
            const listDiv = document.getElementById('doubtList');
            listDiv.innerHTML = '<div class="loading-skeleton h-16 w-full rounded-lg"></div>';
            try {
                const data = await makeDoubtAPICall('/doubts/my-threads');
                listDiv.innerHTML = ''; // Clear skeleton
                if (data.threads.length === 0) {
                    listDiv.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">You have no active doubts.</p>';
                    return;
                }

                data.threads.forEach(thread => {
                    const isNew = thread.status === 'new';
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-4 bg-white dark:bg-gray-700 rounded-lg shadow border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors';
                    item.onclick = () => showDoubtChat(thread._id);

                    item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white truncate" title="${thread.initialQuestion}">${thread.initialQuestion}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${thread.subject} - ${thread.topicId}</p>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                        ${isNew
                            ? '<span class="px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300">New</span>'
                            : '<span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300">In Progress</span>'
                        }
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${formatRelativeTime(thread.updatedAt)}</p>
                    </div>
                `;
                    listDiv.appendChild(item);
                });

            } catch (error) {
                listDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 py-4">${error.message}</p>`;
            }
        }

        function populateDoubtFormSubjects() {
            const select = document.getElementById('doubtSubjectSelect');
            select.innerHTML = '<option value="" disabled selected>Select a subject...</option>';

            if (!dashboardData || !dashboardData.subjects) {
                select.innerHTML = '<option value="">Error loading subjects</option>';
                return;
            }

            // Populate subjects from dashboard data, but only if they are accessible
            Object.keys(dashboardData.subjects).forEach(subjectName => {
                const subjectData = dashboardData.subjects[subjectName];
                const isAccessible = subjectData.topics.some(t => t.status !== 'locked');

                if (isAccessible) {
                    const option = new Option(subjectName, subjectName);
                    select.add(option);
                }
            });
        }

        function handleDoubtSubjectChange() {
            const subjectSelect = document.getElementById('doubtSubjectSelect');
            const topicSelect = document.getElementById('doubtTopicSelect');
            const selectedSubject = subjectSelect.value;

            topicSelect.innerHTML = '<option value="" disabled selected>Select a topic...</option>';
            topicSelect.disabled = true;

            if (!selectedSubject || !dashboardData || !dashboardData.subjects[selectedSubject]) {
                return;
            }

            const topics = dashboardData.subjects[selectedSubject].topics;
            topics.forEach(topic => {
                // Only allow asking doubts about non-locked topics
                if (topic.status !== 'locked') {
                    const option = new Option(topic.name, topic.id);
                    topicSelect.add(option);
                }
            });

            topicSelect.disabled = false;
        }

        async function submitNewDoubt(event) {
            event.preventDefault();
            const subject = document.getElementById('doubtSubjectSelect').value;
            const topicId = document.getElementById('doubtTopicSelect').value;
            const initialQuestion = document.getElementById('doubtInitialQuestion').value;
            const errorP = document.getElementById('newDoubtError');

            if (!subject || !topicId || !initialQuestion) {
                errorP.textContent = 'Please fill out all required fields.';
                return;
            }

            setButtonLoading('submitNewDoubtBtn', 'submitDoubtBtnText', 'submitDoubtBtnSpinner', true);
            errorP.textContent = '';

            try {
                await makeDoubtAPICall('/doubts/new', {
                    method: 'POST',
                    body: JSON.stringify({ subject, topicId, initialQuestion })
                });

                showAlert('Doubt submitted successfully!', 'success');
                document.getElementById('newDoubtForm').reset();
                showDoubtList(); // Go back to the list view

            } catch (error) {
                errorP.textContent = error.message;
            } finally {
                setButtonLoading('submitNewDoubtBtn', 'submitDoubtBtnText', 'submitDoubtBtnSpinner', false);
            }
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.round(diffMs / 1000);
            const diffMinutes = Math.round(diffSeconds / 60);
            const diffHours = Math.round(diffMinutes / 60);
            const diffDays = Math.round(diffHours / 24);

            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return `Yesterday`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        async function openUserDoubtChat(threadId) {
            document.getElementById('currentUserChatThreadId').value = threadId;
            const chatArea = document.getElementById('userChatArea');
            const loadingDiv = document.getElementById('userChatLoading');
            const title = document.getElementById('doubtChatTitle');
            const subject = document.getElementById('doubtChatSubject');
            const resolveBtn = document.getElementById('userResolveDoubtBtn');

            chatArea.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const data = await makeDoubtAPICall(`/doubts/thread/${threadId}`);
                title.textContent = data.thread.initialQuestion.substring(0, 50) + '...';
                subject.textContent = `${data.thread.subject} - ${data.thread.topicId}`;
                renderUserMessages(data.messages);

                if (data.thread.status === 'resolved') {
                    resolveBtn.disabled = true;
                    resolveBtn.textContent = 'Resolved';
                } else {
                    resolveBtn.disabled = false;
                    resolveBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Resolved';
                }

                chatArea.classList.remove('hidden');
            } catch (error) {
                title.textContent = "Error";
                subject.textContent = error.message;
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function renderUserMessages(messages) {
            const messagesContainer = document.getElementById('userChatMessages');
            messagesContainer.innerHTML = '';

            messages.forEach(msg => {
                const isMentor = msg.senderRole === 'mentor';
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${isMentor ? 'mentor' : 'user'}`;

                msgDiv.innerHTML = `
                <div class="message-sender">${msg.senderId ? msg.senderId.username : 'Unknown User'} (${formatRelativeTime(msg.createdAt)})</div>
                <div class="message-bubble">${msg.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
            `;
                messagesContainer.appendChild(msgDiv);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendUserReply() {
            const threadId = document.getElementById('currentUserChatThreadId').value;
            const messageInput = document.getElementById('userReplyMessage');
            const sendBtn = document.getElementById('sendUserReplyBtn');
            const message = messageInput.value.trim();

            if (!message || !threadId) return;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const data = await makeDoubtAPICall(`/doubts/thread/${threadId}/reply`, {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });

                if (data.success && data.newMessage) {
                    messageInput.value = '';
                    const messagesContainer = document.getElementById('userChatMessages');
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `chat-message user`;
                    msgDiv.innerHTML = `
                    <div class="message-sender">${data.newMessage.senderId?.username || 'You'} (just now)</div>
                    <div class="message-bubble">${data.newMessage.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                `;
                    messagesContainer.appendChild(msgDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    // If thread was resolved, re-enable the resolve button
                    const resolveBtn = document.getElementById('userResolveDoubtBtn');
                    resolveBtn.disabled = false;
                    resolveBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Resolved';
                }
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        async function resolveUserThread() {
            const threadId = document.getElementById('currentUserChatThreadId').value;
            if (!threadId) return;

            if (!confirm('Are you sure you want to resolve this thread? You can reopen it by sending a new message.')) {
                return;
            }

            const resolveBtn = document.getElementById('userResolveDoubtBtn');
            resolveBtn.disabled = true;
            resolveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resolving...';

            try {
                await makeDoubtAPICall(`/doubts/thread/${threadId}/resolve`, {
                    method: 'POST'
                });
                showAlert('Thread marked as resolved!', 'success');
                resolveBtn.textContent = 'Resolved';
            } catch (error) {
                showAlert(error.message, 'error');
                resolveBtn.disabled = false;
                resolveBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Resolved';
            }
        }

        // --- END NEW DOUBT FUNCTIONS ---

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            window.addEventListener('pageshow', function (event) {
                if (!getAuthToken()) { redirectToAuth(); }
            });
            const token = getAuthToken();
            if (!token) { redirectToAuth(); return; }

            initializeTheme();
            initializeUser();
            createParticles();

            await loadDashboardData();

            // Event listeners
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('backToSubjectsBtn').addEventListener('click', showSubjectsView);
            document.getElementById('backToTopicsBtn').addEventListener('click', () => showTopicsList(document.getElementById('topicListTitle').textContent.replace(' Topics', ''), currentTopicsArray));

            // Quick action buttons
            document.getElementById('randomChallenge').addEventListener('click', () => {
                showAlert('Random challenge feature coming soon!', 'info');
            });

            document.getElementById('viewProgress').addEventListener('click', () => {
                showAlert('Detailed progress overview coming soon!', 'info');
            });
            // --- NEW DOUBT MODAL LISTENERS ---
            document.getElementById('askDoubtBtn').addEventListener('click', openDoubtModal);
            document.getElementById('doubtModal').addEventListener('click', (e) => {
                if (e.target.id === 'doubtModal') closeDoubtModal();
            });
            document.getElementById('doubtSubjectSelect').addEventListener('change', handleDoubtSubjectChange);
            document.getElementById('newDoubtForm').addEventListener('submit', submitNewDoubt);
            // --- END NEW LISTENERS ---

            console.log("Dashboard initialized.");
        });
    </script>
</body>

</html>

