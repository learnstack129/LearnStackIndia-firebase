<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Challenge - LearnStackIndia</title>
    <script>
      (function() {
        // Set theme from local storage
        const savedTheme = localStorage.getItem('theme') || 'light'; 
        if (savedTheme === 'dark') document.documentElement.classList.add('dark');
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: {} } };
    </script>
    <style>
        /* Base styles */
        body {
            background-color: #f8fafc; /* bg-gray-50 */
        }
        .dark body {
            background-color: #0f172a; /* dark:bg-gray-900 */
        }

        /* CodeMirror Editor Styling */
        .CodeMirror {
            border: 1px solid #e2e8f0; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            height: 400px;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        .dark .CodeMirror {
            border-color: #4b5563; /* dark:border-gray-600 */
        }
        /* Dark theme for CodeMirror */
        .cm-s-material-darker.CodeMirror {
            background-color: #263238;
            color: #EEFFFF;
        }
        
        /* Loading Skeleton */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Markdown Problem Description Styles */
        .problem-description h1, .problem-description h2, .problem-description h3 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0; /* dark:border-gray-700 */
            padding-bottom: 0.25rem;
        }
        .dark .problem-description h1, .dark .problem-description h2, .dark .problem-description h3 {
             border-color: #4b5563;
        }
        .problem-description h1 { font-size: 1.5em; }
        .problem-description h2 { font-size: 1.25em; }
        .problem-description p { margin-bottom: 1rem; line-height: 1.6; }
        .problem-description code {
            background-color: #f1f5f9;
            color: #1e293b;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }
        .problem-description pre {
            background-color: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        .problem-description pre code { background-color: transparent; padding: 0; }
        .dark .problem-description code { background-color: #334155; color: #f1f5f9; }
        .dark .problem-description pre { background-color: #1e293b; }
        .dark .problem-description pre code { background-color: transparent; }
        .problem-description ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .problem-description ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }

        /* Button styles */
        .btn-primary {
            padding: 0.75rem 1.5rem;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <nav class="bg-white dark:bg-gray-800 shadow-lg relative z-10 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="dashboard.html" class="flex items-center space-x-2">
                    <i class="fas fa-arrow-left text-blue-600 dark:text-blue-400"></i>
                    <span class="text-lg font-bold text-gray-700 dark:text-gray-300">Back to Dashboard</span>
                </a>
                <div class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    <i class="fas fa-code mr-2 text-blue-600"></i> LearnStackIndia
                </div>
            </div>
        </div>
    </nav>
    
    <div id="loader" class="text-center p-12">
        <div class="loading-skeleton h-12 w-1/2 mx-auto rounded-lg"></div>
        <div class="loading-skeleton h-32 w-full mt-6 rounded-lg"></div>
        <div class="loading-skeleton h-64 w-full mt-6 rounded-lg"></div>
    </div>
    
    <div id="content" class="hidden max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 lg:h-[85vh] overflow-y-auto">
            <h1 id="problemTitle" class="text-3xl font-bold mb-4 border-b pb-4 border-gray-200 dark:border-gray-700">
                <div class="loading-skeleton h-10 w-3/4 rounded"></div>
            </h1>
            <div id="problemDescription" class="problem-description">
                <div class="loading-skeleton h-6 w-full rounded mb-4"></div>
                <div class="loading-skeleton h-4 w-5/6 rounded mb-4"></div>
                <div class="loading-skeleton h-4 w-full rounded mb-4"></div>
            </div>
        </div>
        
        <div class="flex flex-col space-y-6">
            <div id="mentorFeedbackContainer" class="hidden">
                <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white"><i class="fas fa-user-tie text-blue-500 mr-2"></i>Mentor Feedback</h3>
                <div class="bg-blue-50 dark:bg-gray-800 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                    <p id="mentorFeedbackText" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></p>
                </div>
            </div>

            <div id="solutionContainer" class="hidden">
                <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white"><i class="fas fa-check-circle text-green-500 mr-2"></i>Official Solution</h3>
                <div id="solutionCode" class="bg-gray-100 dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                    </div>
            </div>

            <div id="editorContainer">
                <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white"><i class="fas fa-code text-gray-500 mr-2"></i>Your Code</h3>
                <textarea id="codeEditor"></textarea>
            </div>
            
            <div id="outputContainer" class="bg-gray-900 text-white font-mono p-4 rounded-lg min-h-[100px] shadow-inner">
                <pre id="outputContent" class="whitespace-pre-wrap text-sm">Ready to run... Click "Submit" to test your code.</pre>
            </div>
            
            <div class="flex justify-between items-center">
                <span id="runCountDisplay" class="text-lg font-semibold text-gray-700 dark:text-gray-300">Attempt 1 / 2</span>
                <button id="submitBtn" class="btn-primary bg-green-500 hover:bg-green-600 disabled:opacity-50">
                    <span id="submitBtnText"><i class="fas fa-play mr-2"></i>Submit Code</span>
                    <span id="submitBtnSpinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Running...</span>
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>

    <script>
      // frontend/daily_problem.js

// --- Globals ---
const API_BASE_URL = '/api';
let problemId = null;
let codeEditor = null;
let solutionEditor = null;
let currentAttempt = null;
let currentProblem = null;
let isSubmitting = false;

// --- DOM Elements ---
const loader = document.getElementById('loader');
const content = document.getElementById('content');
const problemTitle = document.getElementById('problemTitle');
const problemDescription = document.getElementById('problemDescription');
const editorContainer = document.getElementById('editorContainer');
const outputContent = document.getElementById('outputContent');
const runCountDisplay = document.getElementById('runCountDisplay');
const submitBtn = document.getElementById('submitBtn');
const submitBtnText = document.getElementById('submitBtnText');
const submitBtnSpinner = document.getElementById('submitBtnSpinner');
const mentorFeedbackContainer = document.getElementById('mentorFeedbackContainer');
const mentorFeedbackText = document.getElementById('mentorFeedbackText');
const solutionContainer = document.getElementById('solutionContainer');


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. Check Auth
    if (!getAuthToken()) {
        window.location.href = 'auth.html';
        return;
    }
    
    // 2. Get Problem ID from URL
    const params = new URLSearchParams(window.location.search);
    problemId = params.get('problemId');
    if (!problemId) {
        alert('Problem ID not found.');
        window.location.href = 'dashboard.html';
        return;
    }

    // 3. Initialize CodeMirror editor
    codeEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
        lineNumbers: true,
        mode: 'javascript', // Default, will be changed
        theme: document.documentElement.classList.contains('dark') ? 'material-darker' : 'default',
        lineWrapping: true
    });

    // 4. Add Listeners
    submitBtn.addEventListener('click', handleSubmit);

    // 5. Load all page data
    loadPageData();
});

function getAuthToken() {
    return localStorage.getItem('authToken');
}

// --- API Calls ---
async function makeAPICall(endpoint, options = {}) {
    const token = getAuthToken();
    if (!token) {
        window.location.href = 'auth.html';
        throw new Error('No auth token');
    }
    
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers
        },
        ...options
    });
    
    if (response.status === 401) window.location.href = 'auth.html';
    
    const data = await response.json();
    if (!response.ok) throw new Error(data.message || 'API Error');
    return data;
}

// --- Page Load ---
async function loadPageData() {
    try {
        loader.classList.remove('hidden');
        content.classList.add('hidden');
        
        // Fetch problem details and user's attempt status in parallel
        const [problemData, attemptData] = await Promise.all([
            makeAPICall(`/daily-problem/details/${problemId}`),
            makeAPICall(`/daily-problem/my-attempt/${problemId}`)
        ]);

        currentProblem = problemData.problem;
        currentAttempt = attemptData.attempt;

        // Populate UI
        problemTitle.textContent = currentProblem.title;
        problemDescription.innerHTML = marked.parse(currentProblem.description); // Render markdown
        
        // Set editor mode based on problem's language
        let mode = 'javascript';
        const lang = currentProblem.language;
        if (lang === 'python') mode = 'python';
        if (lang === 'c' || lang === 'cpp') mode = 'text/x-c++src';
        if (lang === 'java') mode = 'text/x-java';
        
        codeEditor.setOption('mode', mode);

        // Set UI state based on loaded data
        updateUIBasedOnAttempt();
        
        loader.classList.add('hidden');
        content.classList.remove('hidden');

        // --- START OF BUG FIX ---
        // Refresh CodeMirror instances AFTER their container is visible.
        // This forces them to calculate their layout and display content.
        if (codeEditor) {
            codeEditor.refresh();
        }
        if (solutionEditor) {
            solutionEditor.refresh();
        }
        // --- END OF BUG FIX ---

    } catch (error) {
        console.error('Error loading page data:', error);
        loader.innerHTML = `<p class="text-center text-red-500 p-8">${error.message}</p>`;
    }
}

// --- UI Update Logic ---
function updateUIBasedOnAttempt() {
// ... (This function remains unchanged)
    // 1. Handle Mentor Feedback
    if (currentAttempt.mentorFeedback) {
        mentorFeedbackText.textContent = currentAttempt.mentorFeedback;
        mentorFeedbackContainer.classList.remove('hidden');
    } else {
        mentorFeedbackContainer.classList.add('hidden');
    }

    // 2. Handle Solution Display
    if (currentProblem.solutionCode) { // solutionCode is only sent if locked or passed
        solutionContainer.classList.remove('hidden');
        if (!solutionEditor) { // Initialize read-only editor
            solutionEditor = CodeMirror(document.getElementById('solutionCode'), {
                value: currentProblem.solutionCode,
                mode: codeEditor.getOption('mode'),
                theme: document.documentElement.classList.contains('dark') ? 'material-darker' : 'default',
                lineNumbers: true,
                readOnly: true
            });
        } else {
            // If editor already exists, just set the value
            solutionEditor.setValue(currentProblem.solutionCode);
        }
    } else {
        solutionContainer.classList.add('hidden');
    }
    
    // 3. Handle Editor and Submit Button State
    if (currentAttempt.isLocked) {
        codeEditor.setValue(currentAttempt.lastSubmittedCode || currentProblem.boilerplateCode);
        codeEditor.setOption('readOnly', true);
        outputContent.textContent = `Challenge Locked.\nFinal Result: ${currentAttempt.lastResults}`;
        runCountDisplay.textContent = "Attempts used";
        submitBtn.disabled = true;
        submitBtnText.textContent = currentAttempt.passed ? "Solved" : "Locked";
        if (currentAttempt.passed) submitBtn.classList.replace('bg-green-500', 'bg-blue-600');
        else submitBtn.classList.replace('bg-green-500', 'bg-red-600');
        
    } else {
        // Not locked, not passed. User can submit.
        codeEditor.setValue(currentAttempt.lastSubmittedCode || currentProblem.boilerplateCode);
        codeEditor.setOption('readOnly', false);
        outputContent.textContent = currentAttempt.lastResults ? `Last Result: ${currentAttempt.lastResults}\n\nReady for next attempt...` : "Ready to run... Click 'Submit' to test your code.";
        runCountDisplay.textContent = `Attempt ${currentAttempt.runCount + 1} / 2`;
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-blue-600', 'bg-red-600');
        submitBtn.classList.add('bg-green-500');
        submitBtnText.textContent = "Submit Code";
    }
}

// --- Submit Logic (Synchronous Flow) ---
async function handleSubmit() {
    if (isSubmitting) return;
    
    isSubmitting = true;
    setSubmitLoading(true);
    outputContent.textContent = "Submitting to sandbox... This may take a few seconds...";

    try {
        const submittedCode = codeEditor.getValue();

        // --- Step 1: Send to our Vercel API and WAIT for the result ---
        const response = await makeAPICall('/daily-problem/submit', {
            method: 'POST',
            body: JSON.stringify({
                problemId: problemId,
                submittedCode: submittedCode
            })
        });

        // The response *is* the final result
        // Update local state with the final, confirmed state from our server
        currentAttempt = response.finalState;
        currentProblem.solutionCode = response.finalState.solutionCode; // Get solution if locked
        
        // Refresh the entire UI based on the new state
        updateUIBasedOnAttempt(); 

    } catch (error) {
        outputContent.textContent = `Error: ${error.message}`;
        // If error, refresh state from server to be safe
        await loadPageData();
    } finally {
        isSubmitting = false;
        setSubmitLoading(false);
    }
}

// --- Misc UI Helpers ---
function setSubmitLoading(isLoading) {
    if (isLoading) {
        submitBtn.disabled = true;
        submitBtnText.classList.add('hidden');
        submitBtnSpinner.classList.remove('hidden');
    } else {
        submitBtn.disabled = false;
        submitBtnText.classList.remove('hidden');
        submitBtnSpinner.classList.add('hidden');
    }
}
    </script>
</body>
</html>
