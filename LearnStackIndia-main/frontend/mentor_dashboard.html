<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Dashboard - LearnStackIndia</title>
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        };
    </script>
    <style>
        /* frontend/mentor_dashboard.css */
        body {
            background-color: #f1f5f9;
            scroll-behavior: smooth;
        }

        .dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .sidebar {
            width: 250px;
            transition: transform 0.3s ease-in-out;
        }

        .content {
            flex: 1;
        }

        /* Modal Styling */
        .modal {
            display: none;
            /* Hidden by default */
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content-anim {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Skeleton */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.5rem;
        }

        .dark .loading-skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Active Nav Link */
        .nav-link.active {
            font-weight: 600;
            color: #2563eb;
            /* text-blue-600 */
            background-color: #e5e7eb;
            /* bg-gray-200 */
        }

        .dark .nav-link.active {
            color: #60a5fa;
            /* text-blue-400 */
            background-color: #374151;
            /* dark:bg-gray-700 */
        }

        /* Table Responsive Styles */
        table {
            table-layout: fixed;
            width: 100%;
        }

        td,
        th {
            word-wrap: break-word;
            vertical-align: middle;
        }

        /* NEW: Sub-table for questions */
        .questions-sub-table {
            width: 100%;
            margin-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
            /* dark:border-gray-700 */
        }

        .dark .questions-sub-table {
            border-top-color: #374151;
        }

        .questions-sub-table th {
            background-color: #f9fafb;
            /* bg-gray-50 */
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            color: #6b7280;
            /* text-gray-500 */
        }

        .dark .questions-sub-table th {
            background-color: #374151;
            /* dark:bg-gray-700 */
            color: #9ca3af;
            /* dark:text-gray-400 */
        }

        .questions-sub-table td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .content {
                margin-left: 0 !important;
            }

            thead {
                display: none;
            }

            tbody>tr>td {
                /* Only target direct children tds for data-label */
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            tbody>tr>td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: calc(50% - 1rem);
                padding-right: 0.5rem;
                font-weight: bold;
                text-align: left;
                white-space: nowrap;
                color: #6b7280;
            }

            tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 0.5rem;
                background-color: #fff;
            }

            .dark tbody tr {
                border-color: #374151;
                background-color: #1f2937;
            }

            .dark tbody>tr>td::before {
                color: #9ca3af;
            }

            .actions-cell {
                text-align: center !important;
                padding-left: 0 !important;
                width: 100%;
            }

            .actions-cell::before {
                display: none;
            }

            /* NEW: Hide sub-table headers on mobile, they're not needed */
            .questions-sub-table thead {
                display: none;
            }

            .questions-sub-table tr,
            .questions-sub-table td {
                display: block;
                width: 100%;
            }

            .questions-sub-table td {
                text-align: left;
                padding-left: 0.5rem;
                /* Reset padding */
            }

            .questions-sub-table td:last-child {
                text-align: center;
                /* Center actions */
            }
        }

        /* Form Input Field */
        .input-field {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #111827;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s;
            width: 100%;
        }

        .dark .input-field {
            border-color: #4b5563;
            background-color: #374151;
            color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Buttons */
        .btn-primary {
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            color: #111827;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }

        .dark .btn-secondary {
            background-color: #4b5563;
            color: #f9fafb;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .dark .btn-secondary:hover {
            background-color: #6b7280;
        }

        .btn-danger {
            padding: 0.25rem 0.5rem;
            background-color: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Global Alert */
        #globalAlert button {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* --- ADD THIS NEW STYLE FOR CODE TEXTAREAS --- */
        .code-textarea {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.875rem;
            /* text-sm */
            line-height: 1.6;
            min-height: 150px;
            background-color: #f9fafb;
            color: #111827;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .dark .code-textarea {
            background-color: #1f2937;
            /* dark:bg-gray-800 */
            color: #f9fafb;
            /* dark:text-gray-50 */
            border-color: #4b5563;
            /* dark:border-gray-600 */
        }

        .code-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* --- END NEW STYLE --- */

        /* Ensure responsive tables work */
        @media (max-width: 768px) {
            tbody>tr>td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            tbody>tr>td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: calc(50% - 1rem);
                padding-right: 0.5rem;
                font-weight: bold;
                text-align: left;
                white-space: nowrap;
                color: #6b7280;
            }

            .dark tbody>tr>td::before {
                color: #9ca3af;
            }

            .actions-cell {
                text-align: center !important;
                padding-left: 0 !important;
                width: 100%;
            }

            .actions-cell::before {
                display: none;
            }
        }

        /* --- FIX: Hides inactive sections --- */
        .hidden {
            display: none;
        }

        /* --- NEW: Tab Styles --- */
        .tab-list {
            display: flex;
            border-bottom: 2px solid var(--border-color);
        }

        .dark .tab-list {
            border-bottom-color: #4b5563;
            /* dark:border-gray-600 */
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: var(--text-secondary-light);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            /* Overlap the parent border */
        }

        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-primary-light);
        }

        .tab-content {
            display: none;
            /* Hidden by default */
            padding-top: 1.5rem;
        }

        .tab-content.active {
            display: block;
            /* Shown when active */
        }

        /* --- End Tab Styles --- */

        /* --- NEW: Doubt Chat Styles --- */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 60vh;
            /* Fixed height for chat */
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
            /* bg-gray-50 */
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
            border-radius: 0.5rem;
            /* rounded-lg */
        }

        .dark .chat-messages {
            background-color: #1f2937;
            /* dark:bg-gray-800 */
            border-color: #374151;
            /* dark:border-gray-700 */
        }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 80%;
        }

        .chat-message.user {
            margin-left: auto;
            text-align: right;
        }

        .chat-message.mentor {
            margin-right: auto;
            text-align: left;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            /* rounded-xl */
            display: inline-block;
            text-align: left;
            white-space: pre-wrap;
            /* Allow line breaks */
            word-wrap: break-word;
            /* Break long words */
        }

        .chat-message.user .message-bubble {
            background-color: #dbeafe;
            /* bg-blue-100 */
            color: #1e3a8a;
            /* text-blue-900 */
            border-bottom-right-radius: 0.25rem;
        }

        .dark .chat-message.user .message-bubble {
            background-color: #2563eb;
            /* dark:bg-blue-600 */
            color: #ffffff;
            /* dark:text-white */
        }

        .chat-message.mentor .message-bubble {
            background-color: #e5e7eb;
            /* bg-gray-200 */
            color: #1f2937;
            /* text-gray-800 */
            border-bottom-left-radius: 0.25rem;
        }

        .dark .chat-message.mentor .message-bubble {
            background-color: #4b5563;
            /* dark:bg-gray-600 */
            color: #f3f4f6;
            /* dark:text-gray-100 */
        }

        .message-sender {
            font-size: 0.75rem;
            /* text-xs */
            font-weight: 600;
            color: #6b7280;
            /* text-gray-500 */
            margin-bottom: 0.25rem;
        }

        .dark .message-sender {
            color: #9ca3af;
            /* dark:text-gray-400 */
        }

        .chat-input-area {
            display: flex;
            gap: 0.75rem;
            /* space-x-3 */
            margin-top: 1rem;
        }

        .chat-input {
            flex-grow: 1;
        }

        /* --- End Doubt Chat Styles --- */

        /* --- NEW: Responsive Chat --- */
        @media (max-width: 768px) {
            .chat-container {
                height: 50vh;
                /* Slightly smaller height on mobile */
            }

            .chat-message {
                max-width: 90%;
                /* Allow messages to be a bit wider */
            }
        }

        /* --- End Responsive Chat --- */
    </style>
</head>

<body class="dark:bg-gray-900">
    <div class="flex h-screen bg-gray-100 dark:bg-gray-900 overflow-hidden">
        <aside
            class="sidebar bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-4 shadow-lg flex flex-col fixed inset-y-0 left-0 z-20 w-64 md:static transform -translate-x-full md:translate-x-0">
            <div class="text-2xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">
                <i class="fas fa-chalkboard-teacher mr-2"></i>Mentor Panel
            </div>
            <nav class="flex-grow">
                <ul>
                    <li class="mb-2"><a href="#my-tests"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 active"><i
                                class="fas fa-file-alt mr-2 w-4 inline-block text-center"></i>My Tests</a></li>

                    <li class="mb-2"><a href="#daily-challenges"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-calendar-day mr-2 w-4 inline-block text-center"></i>Daily Challenges</a>
                    </li>
                    <li class="mb-2"><a href="#review-submissions"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-user-check mr-2 w-4 inline-block text-center"></i>Review Submissions</a>
                    </li>
                    <li class="mb-2"><a href="#leaderboard"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-trophy mr-2 w-4 inline-block text-center"></i>Leaderboard</a></li>
                    <li class="mb-2"><a href="#monitoring"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-eye mr-2 w-4 inline-block text-center"></i>Live Monitoring</a></li>
                    <li class="mb-2"><a href="#review-submissions"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700"><i
                                class="fas fa-user-check mr-2 w-4 inline-block text-center"></i>Review Submissions</a>
                    </li>
                    <li class="mb-2"><a href="#doubts"
                            class="nav-link block p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i class="fas fa-question-circle mr-2 w-4 inline-block text-center"></i>Doubts
                            <span id="new-doubts-badge"
                                class="hidden ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full"></span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div>
                <button id="mentorLogoutBtn"
                    class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600 mt-4 focus:outline-none focus:ring-2 focus:ring-red-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                </button>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black opacity-50 z-10 hidden md:hidden" onclick="toggleMobileMenu()">
        </div>

        <main class="content p-6 overflow-y-auto flex-1 md:ml-0">
            <button id="mobileMenuBtn"
                class="md:hidden fixed top-4 right-4 z-30 p-2 bg-white dark:bg-gray-700 rounded shadow focus:outline-none focus:ring-2 focus:ring-blue-300">
                <i class="fas fa-bars text-gray-600 dark:text-gray-300"></i>
            </button>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">Mentor Dashboard</h1>

            <section id="my-tests" class="mb-8 mentor-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">My Tests</h2>
                    <button onclick="openCreateTestModal()"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <i class="fas fa-plus mr-1"></i> Create New Test
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Test Title</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Questions</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="daily-challenges" class="mb-8 mentor-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Manage Daily Challenges</h2>
                    <button onclick="openCreateDailyProblemModal()"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        <i class="fas fa-plus mr-1"></i> Create New Challenge
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Title</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Subject</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dailyChallengesTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="review-submissions" class="mb-8 mentor-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Review Submissions</h2>
                    <button onclick="loadSubmissionsForReview()"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        User</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Problem</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Result</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Date</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviewSubmissionsTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="doubts" class="mb-8 mentor-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Doubt Center</h2>
                </div>

                <div class="tab-list mb-4">
                    <button class="tab-button active" data-tab="new-doubts-tab">
                        New Queue
                        <span id="new-doubts-count-badge"
                            class="hidden ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full"></span>
                    </button>
                    <button class="tab-button" data-tab="my-doubts-tab">My Active Doubts</button>
                </div>

                <div id="new-doubts-tab" class="tab-content active">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="overflow-x-auto p-4">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            User</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Subject</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Question</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Received</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="newDoubtsTableBody"
                                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="my-doubts-tab" class="tab-content">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="overflow-x-auto p-4">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            User</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Subject</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Question</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Last Activity</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="myDoubtsTableBody"
                                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="leaderboard" class="mb-8 mentor-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Test Leaderboard</h2>
                <div
                    class="mb-4 flex flex-col sm:flex-row sm:items-end sm:gap-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                    <div class="flex-grow">
                        <label for="leaderboardTestSelect"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select a Test:</label>
                        <select id="leaderboardTestSelect" class="input-field mt-1 w-full md:w-1/2">
                            <option value="">Loading tests...</option>
                        </select>
                    </div>
                    <button id="loadLeaderboardBtn" class="btn-primary mt-2 sm:mt-0" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-search mr-1"></i>Load Leaderboard
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/6">
                                        Position</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-2/6">
                                        Username</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-1/6">
                                        Score</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-2/6">
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400"
                                        data-label="Info">Please select a test and click "Load Leaderboard".</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="monitoring" class="mb-8 mentor-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Live Monitoring</h2>
                <div class="mb-4 flex flex-col sm:flex-row sm:items-end sm:gap-4">
                    <div class="flex-grow">
                        <label for="monitorTestSelect"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Test to
                            Monitor:</label>
                        <select id="monitorTestSelect" class="input-field mt-1 w-full md:w-1/3">
                            <option value="">Loading tests...</option>
                        </select>
                    </div>
                    <button id="refreshMonitorBtn" class="btn-primary mt-2 sm:mt-0" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="overflow-x-auto p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        User</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Strikes</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider actions-cell">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monitoringTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400"
                                        data-label="Info">Select a test to see live attempts.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="createTestModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Create New Test</h3>
                    <button onclick="closeCreateTestModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
                <form id="createTestForm" class="space-y-4 px-7 py-3">
                    <div>
                        <label for="newTestTitle"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test Title*</label>
                        <input type="text" id="newTestTitle" required class="input-field">
                    </div>
                    <div>
                        <label for="newTestPassword"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test
                            Password*</label>
                        <input type="password" id="newTestPassword" required class="input-field">
                    </div>
                    <p id="createTestError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeCreateTestModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveTestBtn" type="button" class="btn-primary">Create Test</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addQuestionModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="addQuestionModalTitle">
                        Add Question</h3>
                    <button onclick="closeAddQuestionModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-times text-xl"></i></button>
                </div>

                <form id="addQuestionForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="addQuestionTestId">
                    <input type="hidden" id="editQuestionId">
                    <div>
                        <label for="questionText"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question
                            Text*</label>
                        <textarea id="questionText" rows="3" required class="input-field"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="questionType"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question
                                Type*</label>
                            <select id="questionType" required class="input-field">
                                <option value="mcq" selected>Multiple Choice (MCQ)</option>
                                <option value="short_answer">Short Answer</option>
                            </select>
                        </div>
                        <div>
                            <label for="questionTimeLimit"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Limit
                                (seconds)*</label>
                            <input type="number" id="questionTimeLimit" required class="input-field" value="90"
                                min="10">
                        </div>
                    </div>
                    <div id="mcqFields" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="questionOption0"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option
                                    1*</label>
                                <input type="text" id="questionOption0" class="input-field option-input">
                            </div>
                            <div>
                                <label for="questionOption1"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option
                                    2*</label>
                                <input type="text" id="questionOption1" class="input-field option-input">
                            </div>
                            <div>
                                <label for="questionOption2"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option
                                    3</label>
                                <input type="text" id="questionOption2" class="input-field option-input">
                            </div>
                            <div>
                                <label for="questionOption3"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Option
                                    4</label>
                                <input type="text" id="questionOption3" class="input-field option-input">
                            </div>
                        </div>
                        <div>
                            <label for="correctAnswerIndex"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Correct
                                Answer*</label>
                            <select id="correctAnswerIndex" class="input-field">
                                <option value="" disabled selected>Select correct option</option>
                                <option value="0">Option 1</option>
                                <option value="1">Option 2</option>
                                <option value="2">Option 3</option>
                                <option value="3">Option 4</option>
                            </select>
                        </div>
                    </div>
                    <div id="shortAnswerFields" class="space-y-4 hidden">
                        <div>
                            <label for="shortAnswers"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Acceptable
                                Answers*</label>
                            <textarea id="shortAnswers" rows="4" class="input-field"
                                placeholder="Enter acceptable answers, one per line."></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Note: Answers are typically
                                case-insensitive, but exact matches are preferred.</p>
                        </div>
                    </div>
                    <p id="addQuestionError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeAddQuestionModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveQuestionBtn" type="button" class="btn-primary">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <div id="createDailyProblemModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="dailyProblemModalTitle">
                        Create New Challenge</h3>
                    <button onclick="closeCreateDailyProblemModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
                <form id="createDailyProblemForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="editDailyProblemId">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="dpTitle"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title*</label>
                            <input type="text" id="dpTitle" required class="input-field">
                        </div>
                        <div>
                            <label for="dpSubject"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject*</label>
                            <input type="text" id="dpSubject" required class="input-field"
                                placeholder="e.g., DSA Visualizer">
                        </div>
                        <div>
                            <label for="dpPoints"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Points for First
                                Attempt*</label>
                            <input type="number" id="dpPoints" required class="input-field" value="20" min="0">
                        </div>
                    </div>

                    <div>
                        <label for="dpDescription"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description
                            (Markdown supported)*</label>
                        <textarea id="dpDescription" rows="5" required class="input-field code-textarea"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="dpLanguage"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Language*</label>
                            <input type="text" id="dpLanguage" required class="input-field" value="javascript"
                                placeholder="e.g., javascript, python">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">OneCompiler name (e.g.,
                                "javascript", "python", "c")</p>
                        </div>
                        <div>
                            <label for="dpTestCases"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test Cases
                                (JSON)*</label>
                            <textarea id="dpTestCases" rows="4" required class="input-field code-textarea"
                                placeholder='[{"input":"5 10","expectedOutput":"15"},{"input":"1 2","expectedOutput":"3"}]'></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use "input" for stdin and
                                "expectedOutput" for stdout.</p>
                        </div>
                    </div>

                    <div>
                        <label for="dpBoilerplate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Boilerplate Code
                            (for user)</label>
                        <textarea id="dpBoilerplate" rows="6" class="input-field code-textarea"
                            placeholder="function solve(input) {\n  // Your code here\n}"></textarea>
                    </div>

                    <div>
                        <label for="dpSolution"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Solution Code (for
                            user review)*</label>
                        <textarea id="dpSolution" rows="6" required class="input-field code-textarea"
                            placeholder="function solve(input) {\n  const [a, b] = input.split(' ').map(Number);\n  return a + b;\n}"></textarea>
                    </div>

                    <p id="createDailyProblemError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeCreateDailyProblemModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveDailyProblemBtn" type="button" class="btn-primary">Save Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reviewSubmissionModal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div
            class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="reviewModalTitle">Review
                        Submission</h3>
                    <button onclick="closeReviewSubmissionModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
                <form id="reviewSubmissionForm" class="space-y-4 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="reviewUserId">
                    <input type="hidden" id="reviewProblemId">

                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">User: <span id="reviewUsername"
                                class="font-semibold">...</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Problem: <span id="reviewProblemTitle"
                                class="font-semibold">...</span></p>
                        <p class="text-sm text-red-600 dark:text-red-400">Result: <span id="reviewLastResult"
                                class="font-semibold">...</span></p>
                    </div>

                    <div>
                        <label for="reviewSubmittedCode"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">User's Submitted
                            Code</label>
                        <textarea id="reviewSubmittedCode" rows="10" readonly
                            class="input-field code-textarea bg-gray-100 dark:bg-gray-900"></textarea>
                    </div>

                    <div>
                        <label for="reviewMentorFeedback"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Feedback /
                            Suggestion</label>
                        <textarea id="reviewMentorFeedback" rows="5" required
                            class="input-field code-textarea"></textarea>
                    </div>

                    <p id="reviewSubmissionError" class="text-red-500 text-sm h-4"></p>
                </form>
                <div
                    class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeReviewSubmissionModal()" type="button" class="btn-secondary">Cancel</button>
                    <button id="saveFeedbackBtn" type="button" class="btn-primary">Submit Feedback</button>
                </div>
            </div>
        </div>
    </div>

    <div id="doubtChatModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800 modal-content-anim">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 pb-3 border-b dark:border-gray-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="doubtChatModalTitle">Doubt Conversation</h3>
                    <button onclick="closeDoubtChatModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <input type="hidden" id="currentChatThreadId">
                <div id="doubtChatLoading" class="text-center p-8 hidden">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Loading conversation...</p>
                </div>

                <div id="doubtChatError" class="text-red-500 text-center p-8 hidden"></div>
                
                <div id="doubtChatArea" class="chat-container hidden">
                    <div id="doubtChatMessages" class="chat-messages">
                        </div>
                    
                    <div class="chat-input-area">
                        <textarea id="doubtReplyMessage" class="input-field chat-input" placeholder="Type your answer..." rows="3"></textarea>
                        <button id="sendDoubtReplyBtn" class="btn-primary self-end" onclick="sendDoubtReply()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <div class="items-center px-4 py-3 border-t border-gray-200 dark:border-gray-700 mt-4 flex justify-end space-x-3">
                    <button onclick="closeDoubtChatModal()" type="button" class="btn-secondary">Close</button>
                    <button id="resolveDoubtBtn" type="button" class="btn-primary bg-green-500 hover:bg-green-600" onclick="resolveDoubtThread()">
                        <i class="fas fa-check-circle mr-2"></i>Mark as Resolved
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="globalAlert"
        class="fixed bottom-5 right-5 z-50 hidden max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0">
        <p id="globalAlertMessage" class="mr-4"></p>
        <button onclick="hideGlobalAlert()" aria-label="Close alert">&times;</button>
    </div>

    <script>
        // frontend/mentor_dashboard.js
        const API_BASE_URL = '/api';
        let allMentorTests = []; // Cache for mentor's tests
        let monitoringInterval = null; // Interval for live monitoring

        // --- UTILITIES (Your existing functions) ---
        function getAuthToken() { return localStorage.getItem('authToken'); }
        function checkMentorAuth() {
            const token = getAuthToken();
            const userStr = localStorage.getItem('currentUser');
            let userRole = null;
            if (userStr) { try { userRole = JSON.parse(userStr).role; } catch (e) { } }

            if (!token || (userRole !== 'mentor' && userRole !== 'admin')) {
                console.warn("Not authenticated as mentor/admin, redirecting...");
                if (monitoringInterval) clearInterval(monitoringInterval);
                localStorage.clear();
                window.location.href = 'auth.html';
                return false;
            }
            return true;
        }
        async function makeMentorAPICall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!checkMentorAuth()) return null;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(`${API_BASE_URL}/mentor${endpoint}`, {
                    signal: controller.signal,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers },
                    ...options
                });
                clearTimeout(timeoutId);
                let data;
                try {
                    const text = await response.text();
                    data = text ? JSON.parse(text) : { success: response.ok, message: response.ok ? "Operation successful" : "Operation failed" };
                } catch (e) {
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${response.statusText}. Response not JSON.`);
                    return { success: true };
                }
                if (response.status === 401 || response.status === 403) {
                    checkMentorAuth();
                    return null;
                }
                if (!response.ok) throw new Error(data.message || `HTTP Error ${response.status}`);
                return data;
            } catch (error) {
                const message = error.name === 'AbortError' ? 'Request timed out.' : error.message;
                console.error(`API Error (${endpoint}):`, message, error);
                showGlobalAlert(`Error: ${message}`, 'error');
                return null;
            }
        }
        function showGlobalAlert(message, type = 'info') {
            const alertDiv = document.getElementById('globalAlert');
            const messageP = document.getElementById('globalAlertMessage');
            if (!alertDiv || !messageP) return;
            alertDiv.className = 'fixed bottom-5 right-5 z-50 max-w-sm rounded-md p-4 shadow-lg flex items-center justify-between transition-opacity duration-300 opacity-0';
            messageP.textContent = message;
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            alertDiv.classList.add(colors[type] || colors.info, 'text-white');
            alertDiv.classList.remove('hidden');
            void alertDiv.offsetWidth;
            alertDiv.classList.remove('opacity-0');
            if (alertDiv.alertTimeout) clearTimeout(alertDiv.alertTimeout);
            alertDiv.alertTimeout = setTimeout(hideGlobalAlert, 5000);
        }
        function hideGlobalAlert() {
            const alertDiv = document.getElementById('globalAlert');
            if (!alertDiv) return;
            alertDiv.classList.add('opacity-0');
            setTimeout(() => {
                alertDiv.classList.add('hidden');
                if (alertDiv.alertTimeout) { clearTimeout(alertDiv.alertTimeout); alertDiv.alertTimeout = null; }
            }, 300);
        }

        // --- NAVIGATION (Modified) ---
        function handleNavigation() {
        if (monitoringInterval) {
            clearInterval(monitoringInterval);
            monitoringInterval = null;
            console.log("Stopped monitoring interval.");
        }
    
        const hash = window.location.hash || '#my-tests';
        const targetSectionId = hash.substring(1);
        document.querySelectorAll('.mentor-section').forEach(sec => sec.classList.add('hidden'));
        const targetSection = document.getElementById(targetSectionId) || document.getElementById('my-tests');
        targetSection.classList.remove('hidden');
        const sectionIdToShow = targetSection.id;
    
        document.querySelectorAll('.nav-link').forEach(link => { link.classList.remove('active'); if (link.getAttribute('href') === `#${sectionIdToShow}`) link.classList.add('active'); });
        closeMobileMenu();
        
        if(sectionIdToShow === 'my-tests') {
            loadMentorTests();
        }
        if(sectionIdToShow === 'daily-challenges') {
            loadDailyChallenges();
        }
        if(sectionIdToShow === 'review-submissions') {
            loadSubmissionsForReview();
        }
        if(sectionIdToShow === 'monitoring') {
            populateMonitorTestSelect();
            loadTestAttempts(); 
            console.log("Monitoring tab loaded, interval removed.");
        }
        if(sectionIdToShow === 'leaderboard') {
            populateLeaderboardTestSelect();
            loadLeaderboard(); 
        }
        // --- NEW: Load Doubts ---
        if(sectionIdToShow === 'doubts') {
            loadDoubtsQueue(); // Load the new doubts queue
            loadMyActiveDoubts(); // Load mentor's active doubts
        }
        // --- END NEW ---
    }

        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar'), overlay = document.getElementById('overlay'), isOpen = sidebar.classList.contains('translate-x-0');
            sidebar.classList.toggle('-translate-x-full', isOpen); sidebar.classList.toggle('translate-x-0', !isOpen); overlay.classList.toggle('hidden', isOpen);
        }
        function closeMobileMenu() { document.querySelector('.sidebar').classList.add('-translate-x-full'); document.querySelector('.sidebar').classList.remove('translate-x-0'); document.getElementById('overlay').classList.add('hidden'); }
        function mentorLogout() {
            if (monitoringInterval) clearInterval(monitoringInterval);
            if (confirm('Logout?')) {
                localStorage.clear();
                window.location.href = 'auth.html';
            }
        }

        // --- LEADERBOARD SECTION (Your existing functions) ---
        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboardTableBody');
            const testId = document.getElementById('leaderboardTestSelect').value;

            if (!testId) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Info">Please select a test and click "Load Leaderboard".</td></tr>';
                return;
            }
            tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            const data = await makeMentorAPICall(`/tests/${testId}/attempts`);
            tbody.innerHTML = '';
            if (data?.success && data.attempts) {
                if (data.attempts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No participants found for this test.</td></tr>';
                    return;
                }
                const sortedAttempts = data.attempts.sort((a, b) => b.score - a.score);
                sortedAttempts.forEach((attempt, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    let statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
                    if (attempt.status === 'locked') statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    else if (attempt.status === 'completed') statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Position">${index + 1}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Username">${attempt.username || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm font-bold text-blue-600 dark:text-blue-400" data-label="Score">${attempt.score}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${attempt.status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500" data-label="Error">Failed to load leaderboard.</td></tr>`;
            }
        }

        // --- "MY TESTS" SECTION (Your existing functions) ---
        async function loadMentorTests() {
            const tbody = document.getElementById('testsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';

            const data = await makeMentorAPICall('/tests');
            tbody.innerHTML = '';

            if (data?.success && data.tests) {
                allMentorTests = data.tests;
                if (data.tests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No tests created yet.</td></tr>';
                    return;
                }
                data.tests.forEach(test => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    const questionCount = test.questions ? test.questions.length : 0;

                    const isActive = test.isActive === true;
                    const toggleButtonHtml = isActive
                        ? `<button onclick="toggleTestActive('${test._id}', ${test.isActive})" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 mr-3" title="Deactivate Test"><i class="fas fa-power-off"></i></button>`
                        : `<button onclick="toggleTestActive('${test._id}', ${test.isActive})" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 mr-3" title="Activate Test"><i class="fas fa-power-off"></i></button>`;

                    const escapedTitle = test.title.replace(/'/g, "\\'");

                    const viewQuestionsBtn = `<button onclick="toggleQuestionsList(this, '${test._id}')" class="text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 mr-3" title="View/Hide Questions"><i class="fas fa-chevron-down"></i></button>`;

                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Title">${test.title}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${isActive ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300'}">${isActive ? 'Active' : 'Draft'}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Questions">${questionCount}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            ${viewQuestionsBtn}
                            <button onclick="openAddQuestionModal('${test._id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-3" title="Add Question"><i class="fas fa-plus"></i></button>
                            ${toggleButtonHtml} 
                            <button onclick="deleteTest('${test._id}', '${escapedTitle}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Delete Test"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    const questionsRow = document.createElement('tr');
                    questionsRow.id = `questions-for-${test._id}`;
                    questionsRow.className = "hidden";
                    const questionsCell = document.createElement('td');
                    questionsCell.colSpan = 4;
                    questionsCell.className = "p-0";
                    questionsCell.innerHTML = `<div id="questions-container-${test._id}" class="p-4 bg-gray-50 dark:bg-gray-700"><div class="loading-skeleton h-8 w-full"></div></div>`;
                    questionsRow.appendChild(questionsCell);
                    tbody.appendChild(questionsRow);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load tests.</td></tr>';
            }
        }

        function toggleQuestionsList(button, testId) {
            const row = document.getElementById(`questions-for-${testId}`);
            const icon = button.querySelector('i');
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                renderQuestionsForTest(testId);
            } else {
                row.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function renderQuestionsForTest(testId) {
            const container = document.getElementById(`questions-container-${testId}`);
            const test = allMentorTests.find(t => t._id === testId);

            if (!test || !test.questions || test.questions.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-gray-500 dark:text-gray-400">No questions added to this test yet.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600 questions-sub-table">
                    <thead class="bg-gray-100 dark:bg-gray-600">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Question Text</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-24">Time</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-28">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            `;

            test.questions.forEach(q => {
                tableHtml += `
                    <tr id="question-row-${q._id}">
                        <td class="px-4 py-3 text-gray-700 dark:text-gray-200" data-label="Question">${q.text}</td>
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400" data-label="Time">${q.timeLimit}s</td>
                        <td class="px-4 py-3 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick="openAddQuestionModal('${testId}', '${q._id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3" title="Edit Question"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteQuestion('${testId}', '${q._id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Delete Question"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        async function deleteTest(testId, testName) {
            if (!confirm(`Are you sure you want to permanently delete the test "${testName}"?\n\nThis will also delete ALL associated questions and ALL user attempts for this test.`)) {
                return;
            }
            showGlobalAlert('Deleting test...', 'info');
            const result = await makeMentorAPICall(`/tests/${testId}`, { method: 'DELETE' });
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                loadMentorTests();
                populateMonitorTestSelect();
                populateLeaderboardTestSelect();
            }
        }

        function openCreateTestModal() {
            document.getElementById('createTestForm').reset();
            document.getElementById('createTestError').textContent = '';
            document.getElementById('createTestModal').classList.add('show');
        }
        function closeCreateTestModal() {
            document.getElementById('createTestModal').classList.remove('show');
        }

        async function toggleTestActive(testId, currentStatus) {
            const action = currentStatus ? 'Deactivate' : 'Activate';
            if (!confirm(`Are you sure you want to ${action} this test?`)) {
                return;
            }
            showGlobalAlert(`${action.replace(/e$/, 'ing')} test...`, 'info');
            const result = await makeMentorAPICall(`/tests/${testId}/toggle`, { method: 'POST' });
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                loadMentorTests();
                populateMonitorTestSelect();
                populateLeaderboardTestSelect();
            }
        }

        async function saveNewTest() {
            const title = document.getElementById('newTestTitle').value;
            const password = document.getElementById('newTestPassword').value;
            const errorP = document.getElementById('createTestError');
            const saveButton = document.getElementById('saveTestBtn');
            errorP.textContent = '';
            if (!title || !password) {
                errorP.textContent = 'Title and password are required.';
                return;
            }
            saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            const result = await makeMentorAPICall('/tests', {
                method: 'POST',
                body: JSON.stringify({ title, password })
            });
            saveButton.disabled = false; saveButton.innerHTML = 'Create Test';
            if (result?.success) {
                showGlobalAlert('Test created!', 'success');
                closeCreateTestModal();
                loadMentorTests();
            } else {
                errorP.textContent = result?.message || 'Failed to create test.';
            }
        }

        function setupQuestionTypeToggle() {
            const typeSelect = document.getElementById('questionType');
            if (typeSelect) {
                typeSelect.addEventListener('change', (e) => {
                    const type = e.target.value;
                    toggleQuestionFields(type);
                });
            }
        }

        function toggleQuestionFields(type) {
            const mcqFields = document.getElementById('mcqFields');
            const shortAnswerFields = document.getElementById('shortAnswerFields');
            if (type === 'mcq') {
                mcqFields.classList.remove('hidden');
                shortAnswerFields.classList.add('hidden');
            } else if (type === 'short_answer') {
                mcqFields.classList.add('hidden');
                shortAnswerFields.classList.remove('hidden');
            }
        }

        async function openAddQuestionModal(testId, questionId = null) {
            const form = document.getElementById('addQuestionForm');
            form.reset();
            document.getElementById('addQuestionError').textContent = '';
            document.getElementById('addQuestionTestId').value = testId;
            document.getElementById('editQuestionId').value = questionId || '';
            const title = document.getElementById('addQuestionModalTitle');
            const saveButton = document.getElementById('saveQuestionBtn');
            toggleQuestionFields('mcq');
            document.getElementById('questionType').value = 'mcq';
            if (questionId) {
                title.textContent = 'Edit Question';
                saveButton.innerHTML = 'Save Changes';
                showGlobalAlert('Loading question data...', 'info');
                const data = await makeMentorAPICall(`/questions/${questionId}`);
                hideGlobalAlert();
                if (data?.success && data.question) {
                    const q = data.question;
                    document.getElementById('questionText').value = q.text;
                    document.getElementById('questionTimeLimit').value = q.timeLimit;
                    document.getElementById('questionType').value = q.questionType;
                    toggleQuestionFields(q.questionType);
                    if (q.questionType === 'mcq') {
                        (q.options || []).forEach((opt, i) => {
                            const optInput = document.getElementById(`questionOption${i}`);
                            if (optInput) optInput.value = opt;
                        });
                        document.getElementById('correctAnswerIndex').value = String(q.correctAnswerIndex);
                    } else if (q.questionType === 'short_answer') {
                        document.getElementById('shortAnswers').value = (q.shortAnswers || []).join('\n');
                    }
                } else {
                    showGlobalAlert('Error loading question data. Please close and try again.', 'error');
                    return;
                }
            } else {
                title.textContent = 'Add New Question';
                saveButton.innerHTML = 'Save Question';
                const test = allMentorTests.find(t => t._id === testId);
                if (test) {
                    title.textContent = `Add Question to: ${test.title}`;
                }
            }
            document.getElementById('addQuestionModal').classList.add('show');
        }

        function closeAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.remove('show');
        }

        async function saveNewQuestion() {
            const testId = document.getElementById('addQuestionTestId').value;
            const questionId = document.getElementById('editQuestionId').value;
            const isEditing = !!questionId;
            const errorP = document.getElementById('addQuestionError');
            const saveButton = document.getElementById('saveQuestionBtn');
            errorP.textContent = '';
            saveButton.disabled = true;
            saveButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${isEditing ? 'Saving...' : 'Adding...'}`;
            const questionType = document.getElementById('questionType').value;
            const questionData = {
                text: document.getElementById('questionText').value.trim(),
                timeLimit: parseInt(document.getElementById('questionTimeLimit').value, 10),
                questionType: questionType
            };
            if (!questionData.text || isNaN(questionData.timeLimit) || questionData.timeLimit < 10) {
                errorP.textContent = 'Please fill in Question Text and a valid Time Limit (min 10s).';
                saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
                return;
            }
            if (questionType === 'mcq') {
                questionData.options = [
                    document.getElementById('questionOption0').value.trim(),
                    document.getElementById('questionOption1').value.trim(),
                    document.getElementById('questionOption2').value.trim(),
                    document.getElementById('questionOption3').value.trim(),
                ].filter(opt => opt.length > 0);
                questionData.correctAnswerIndex = parseInt(document.getElementById('correctAnswerIndex').value, 10);
                if (questionData.options.length < 2) {
                    errorP.textContent = 'MCQ questions must have at least 2 options.';
                    saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
                    return;
                }
                if (isNaN(questionData.correctAnswerIndex)) {
                    errorP.textContent = 'Please select a correct answer for the MCQ.';
                    saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
                    return;
                }
                if (questionData.correctAnswerIndex >= questionData.options.length) {
                    errorP.textContent = 'Correct answer index is invalid for the number of options provided.';
                    saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
                    return;
                }
            } else if (questionType === 'short_answer') {
                questionData.shortAnswers = document.getElementById('shortAnswers').value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
                if (questionData.shortAnswers.length === 0) {
                    errorP.textContent = 'Short Answer questions must have at least one acceptable answer.';
                    saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
                    return;
                }
            }
            const method = isEditing ? 'PUT' : 'POST';
            const endpoint = isEditing ? `/questions/${questionId}` : `/tests/${testId}/questions`;
            const result = await makeMentorAPICall(endpoint, {
                method: method,
                body: JSON.stringify(questionData)
            });
            saveButton.disabled = false; saveButton.innerHTML = isEditing ? 'Save Changes' : 'Save Question';
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                closeAddQuestionModal();
                const test = allMentorTests.find(t => t._id === testId);
                if (test) {
                    if (isEditing) {
                        const qIndex = test.questions.findIndex(q => q._id === questionId);
                        if (qIndex !== -1) {
                            test.questions[qIndex] = { ...test.questions[qIndex], ...result.question };
                        }
                    } else {
                        test.questions.push(result.question);
                    }
                    const row = document.getElementById(`questions-for-${testId}`);
                    if (row && !row.classList.contains('hidden')) {
                        renderQuestionsForTest(testId);
                    }
                    loadMentorTests();
                }
            } else {
                errorP.textContent = result?.message || `Failed to ${isEditing ? 'update' : 'add'} question.`;
            }
        }

        async function deleteQuestion(testId, questionId) {
            const questionRow = document.getElementById(`question-row-${questionId}`);
            const questionText = questionRow ? questionRow.cells[0].textContent : 'this question';
            if (!confirm(`Are you sure you want to delete this question?\n\n"${questionText}"`)) {
                return;
            }
            showGlobalAlert('Deleting question...', 'info');
            const result = await makeMentorAPICall(`/tests/${testId}/questions/${questionId}`, { method: 'DELETE' });
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                const test = allMentorTests.find(t => t._id === testId);
                if (test) {
                    test.questions = test.questions.filter(q => q._id !== questionId);
                }
                renderQuestionsForTest(testId);
                loadMentorTests();
            }
        }

        // --- MONITORING SECTION (Your existing functions) ---
        async function populateMonitorTestSelect() {
            const select = document.getElementById('monitorTestSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Loading tests...</option>';
            let testsToUse = allMentorTests;
            if (testsToUse.length === 0) {
                const data = await makeMentorAPICall('/tests');
                if (data?.success && data.tests) {
                    testsToUse = data.tests;
                    allMentorTests = data.tests;
                }
            }
            select.innerHTML = '<option value="" disabled>Select a test</option>';
            if (testsToUse.length > 0) {
                testsToUse.forEach(test => {
                    const option = new Option(`${test.title} (${test.questions.length}Q) ${test.isActive ? '[Active]' : '[Draft]'}`, test._id);
                    select.appendChild(option);
                });
                select.value = currentVal;
            } else {
                select.innerHTML = '<option value="">No tests found</option>';
            }
        }

        async function populateLeaderboardTestSelect() {
            const select = document.getElementById('leaderboardTestSelect');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Loading tests...</option>';
            let testsToUse = allMentorTests;
            if (testsToUse.length === 0) {
                const data = await makeMentorAPICall('/tests');
                if (data?.success && data.tests) {
                    testsToUse = data.tests;
                    allMentorTests = data.tests;
                }
            }
            select.innerHTML = '<option value="">Select a test</option>';
            if (testsToUse.length > 0) {
                testsToUse.forEach(test => {
                    const option = new Option(`${test.title} (${test.questions.length}Q) ${test.isActive ? '[Active]' : '[Draft]'}`, test._id);
                    select.appendChild(option);
                });
                select.value = currentVal;
            } else {
                select.innerHTML = '<option value="">No tests found</option>';
            }
        }

        async function loadTestAttempts() {
            const testId = document.getElementById('monitorTestSelect').value;
            if (!testId) {
                document.getElementById('monitoringTableBody').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Info">Select a test to see live attempts.</td></tr>';
                return;
            }
            const tbody = document.getElementById('monitoringTableBody');
            if (!tbody.hasChildNodes() || tbody.innerHTML.includes('data-label="Info"')) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            }
            const data = await makeMentorAPICall(`/tests/${testId}/attempts`);
            if (data?.success && data.attempts) {
                tbody.innerHTML = '';
                if (data.attempts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No users have started this test yet.</td></tr>';
                    return;
                }
                data.attempts.forEach(attempt => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    let statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
                    if (attempt.status === 'locked') statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    else if (attempt.status === 'completed') statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="User">${attempt.username}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status"><span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${attempt.status}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Strikes">${attempt.strikes} / 3</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            ${attempt.status === 'locked' ?
                            `<button onclick="unlockUserAttempt('${attempt.userId}', '${attempt.attemptId}')" class="btn-danger">
                                    <i class="fas fa-unlock mr-1"></i>Unlock
                                 </button>` :
                            '<span class="text-xs text-gray-400">No actions</span>'
                        }
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load attempts.</td></tr>';
            }
        }

        async function unlockUserAttempt(userId, attemptId) {
            if (!confirm('Are you sure you want to unlock this test for the user? Their strikes will be reset to 0.')) {
                return;
            }
            showGlobalAlert('Unlocking test...', 'info');
            const result = await makeMentorAPICall('/attempts/unlock', {
                method: 'POST',
                body: JSON.stringify({ userId, attemptId })
            });
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                loadTestAttempts();
            }
        }


        // --- *** ADD ALL THE FUNCTIONS BELOW *** ---

        // --- DAILY CHALLENGE FUNCTIONS ---

        async function loadDailyChallenges() {
            const tbody = document.getElementById('dailyChallengesTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            const data = await makeMentorAPICall('/daily-problems');
            tbody.innerHTML = '';
            if (data?.success && data.problems) {
                if (data.problems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No challenges created yet.</td></tr>';
                    return;
                }
                data.problems.forEach(problem => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    const isActive = problem.isActive === true;
                    const toggleButtonHtml = isActive
                        ? `<span class="text-green-600 dark:text-green-400 mr-3" title="Active"><i class="fas fa-check-circle"></i> Active</span>`
                        : `<button onclick="activateDailyProblem('${problem._id}', '${problem.title.replace(/'/g, "\\'")}')" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 mr-3" title="Activate Problem"><i class="fas fa-play-circle"></i> Activate</button>`;
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="Title">${problem.title}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Subject">${problem.subject}</td>
                        <td class="px-6 py-4 text-sm" data-label="Status">${isActive ? `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Active</span>` : `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-300">Draft</span>`}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            ${toggleButtonHtml}
                            <button onclick="openCreateDailyProblemModal('${problem._id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-3" title="Edit Problem (Note: Edit not implemented in this version)"><i class="fas fa-edit"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load challenges.</td></tr>';
            }
        }

        async function openCreateDailyProblemModal(problemId = null) {
            const modal = document.getElementById('createDailyProblemModal');
            const form = document.getElementById('createDailyProblemForm');
            form.reset();
            document.getElementById('createDailyProblemError').textContent = '';
            document.getElementById('editDailyProblemId').value = problemId || '';
            const titleEl = document.getElementById('dailyProblemModalTitle');
            const saveBtn = document.getElementById('saveDailyProblemBtn');

            if (problemId) {
                // --- Logic to load existing data for editing ---
                // This version focuses on creation, so we'll just show a message.
                // In a full implementation, you'd fetch /daily-problem/:problemId
                titleEl.textContent = 'Edit Challenge';
                saveBtn.innerHTML = 'Save Changes';
                saveBtn.disabled = true; // Disabling edit for this example
                showGlobalAlert('Loading problem data...', 'info');

                const data = await makeMentorAPICall('/daily-problems'); // Re-fetch all
                const problem = data?.problems.find(p => p._id === problemId);
                hideGlobalAlert();

                if (problem) {
                    document.getElementById('dpTitle').value = problem.title;
                    document.getElementById('dpSubject').value = problem.subject;
                    document.getElementById('dpPoints').value = problem.pointsForAttempt;
                    document.getElementById('dpDescription').value = problem.description;
                    document.getElementById('dpLanguage').value = problem.language || 'javascript';
                    document.getElementById('dpTestCases').value = JSON.stringify(problem.testCases || [], null, 2);
                    document.getElementById('dpBoilerplate').value = problem.boilerplateCode || '';
                    document.getElementById('dpSolution').value = problem.solutionCode || '';
                    document.getElementById('createDailyProblemError').textContent = 'Editing is not supported in this demo. Please create a new challenge.';
                } else {
                    showGlobalAlert('Error: Could not load problem data.', 'error');
                    return;
                }
            } else {
                // --- Logic for creating a new problem ---
                titleEl.textContent = 'Create New Challenge';
                saveBtn.innerHTML = 'Save Challenge';
                saveBtn.disabled = false;
                document.getElementById('dpTestCases').value = '[\n  {\n    "input": "",\n    "expectedOutput": "..."\n  }\n]';
            }
            modal.classList.add('show');
        }

        function closeCreateDailyProblemModal() {
            document.getElementById('createDailyProblemModal').classList.remove('show');
        }

        async function saveDailyProblem() {
            const problemId = document.getElementById('editDailyProblemId').value;
            const isEditing = !!problemId;
            const errorP = document.getElementById('createDailyProblemError');
            const saveButton = document.getElementById('saveDailyProblemBtn');
            errorP.textContent = '';

            // --- Stop if editing ---
            if (isEditing) {
                errorP.textContent = "Editing is not supported in this demo. Please create a new challenge.";
                return;
            }

            let testCases;
            try {
                testCases = JSON.parse(document.getElementById('dpTestCases').value);
                if (!Array.isArray(testCases) || testCases.length === 0) throw new Error("Test cases must be a non-empty array.");
                if (!testCases.every(tc => tc.expectedOutput !== undefined)) throw new Error("Each test case must have an 'expectedOutput' key.");
            } catch (e) {
                errorP.textContent = 'Test Cases must be a valid JSON array (e.g., [{"input":"...", "expectedOutput":"..."}]). ' + e.message;
                return;
            }

            const problemData = {
                title: document.getElementById('dpTitle').value,
                subject: document.getElementById('dpSubject').value,
                pointsForAttempt: parseInt(document.getElementById('dpPoints').value),
                description: document.getElementById('dpDescription').value,
                language: document.getElementById('dpLanguage').value.trim().toLowerCase(),
                testCases: testCases,
                boilerplateCode: document.getElementById('dpBoilerplate').value,
                solutionCode: document.getElementById('dpSolution').value
            };

            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            const result = await makeMentorAPICall('/daily-problem', {
                method: 'POST',
                body: JSON.stringify(problemData)
            });

            saveButton.disabled = false;
            saveButton.innerHTML = 'Save Challenge';

            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                closeCreateDailyProblemModal();
                loadDailyChallenges();
            } else {
                errorP.textContent = result?.message || 'Failed to save challenge.';
            }
        }

        async function activateDailyProblem(problemId, problemTitle) {
            if (!confirm(`Are you sure you want to activate "${problemTitle}"?\nThis will deactivate any other active problem for this subject.`)) {
                return;
            }
            showGlobalAlert('Activating problem...', 'info');
            const result = await makeMentorAPICall(`/daily-problem/${problemId}/activate`, {
                method: 'POST'
            });
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                loadDailyChallenges();
            }
        }

        // --- REVIEW SUBMISSIONS FUNCTIONS ---

        async function loadSubmissionsForReview() {
            const tbody = document.getElementById('reviewSubmissionsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            const data = await makeMentorAPICall('/submissions-for-review');
            tbody.innerHTML = '';
            if (data?.success && data.submissions) {
                if (data.submissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">No submissions are awaiting review.</td></tr>';
                    return;
                }
                data.submissions.forEach(sub => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    const subJson = JSON.stringify(sub).replace(/'/g, "&apos;");
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="User">${sub.username}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Problem">${sub.problemTitle} (${sub.problemSubject})</td>
                        <td class="px-6 py-4 text-sm text-red-600 dark:text-red-400" data-label="Result">${(sub.lastResults || 'Failed').split('\n')[0]}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Date">${new Date(sub.submittedAt).toLocaleString()}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick='openReviewSubmissionModal(${subJson})' class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                                <i class="fas fa-comment-dots mr-1"></i> Review
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load submissions.</td></tr>';
            }
        }

        function openReviewSubmissionModal(submission) {
            const modal = document.getElementById('reviewSubmissionModal');
            const form = document.getElementById('reviewSubmissionForm');
            form.reset();
            document.getElementById('reviewSubmissionError').textContent = '';
            document.getElementById('reviewUserId').value = submission.userId;
            document.getElementById('reviewProblemId').value = submission.problemId;
            document.getElementById('reviewUsername').textContent = submission.username;
            document.getElementById('reviewProblemTitle').textContent = `${submission.problemTitle} (${submission.problemSubject})`;
            document.getElementById('reviewLastResult').textContent = submission.lastResults || 'Failed';
            document.getElementById('reviewSubmittedCode').value = submission.lastSubmittedCode || '// No code was saved.';
            modal.classList.add('show');
        }

        function closeReviewSubmissionModal() {
            document.getElementById('reviewSubmissionModal').classList.remove('show');
        }

        async function saveFeedback() {
            const userId = document.getElementById('reviewUserId').value;
            const problemId = document.getElementById('reviewProblemId').value;
            const feedbackText = document.getElementById('reviewMentorFeedback').value;
            const errorP = document.getElementById('reviewSubmissionError');
            const saveButton = document.getElementById('saveFeedbackBtn');
            if (!feedbackText) {
                errorP.textContent = 'Feedback cannot be empty.';
                return;
            }
            errorP.textContent = '';
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            const result = await makeMentorAPICall('/feedback', {
                method: 'POST',
                body: JSON.stringify({ userId, problemId, feedbackText })
            });
            saveButton.disabled = false;
            saveButton.innerHTML = 'Submit Feedback';
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                closeReviewSubmissionModal();
                loadSubmissionsForReview();
            } else {
                errorP.textContent = result?.message || 'Failed to send feedback.';
            }
        }

        // --- NEW: DOUBT MANAGEMENT FUNCTIONS ---

        function setupTabListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Update buttons
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.round(diffMs / 1000);
            const diffMinutes = Math.round(diffSeconds / 60);
            const diffHours = Math.round(diffMinutes / 60);
            const diffDays = Math.round(diffHours / 24);

            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return `Yesterday`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        async function loadDoubtsQueue() {
            const tbody = document.getElementById('newDoubtsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            
            const data = await makeMentorAPICall('/doubts/queue');
            tbody.innerHTML = '';
            
            const badge = document.getElementById('new-doubts-badge');
            const badgeCount = document.getElementById('new-doubts-count-badge');
            
            if (data?.success && data.doubts) {
                if (data.doubts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">The new doubts queue is empty.</td></tr>';
                    badge.classList.add('hidden');
                    badge.textContent = '';
                    badgeCount.classList.add('hidden');
                    badgeCount.textContent = '';
                    return;
                }
                
                badge.textContent = data.doubts.length;
                badge.classList.remove('hidden');
                badgeCount.textContent = data.doubts.length;
                badgeCount.classList.remove('hidden');
                
                data.doubts.forEach(doubt => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    const escapedQuestion = doubt.initialQuestion.replace(/'/g, "\\'");

                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="User">${doubt.userId ? doubt.userId.username : 'Deleted User'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Subject">${doubt.subject} (${doubt.topicId})</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300 truncate" data-label="Question" title="${doubt.initialQuestion}">${doubt.initialQuestion}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Received">${formatRelativeTime(doubt.createdAt)}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick="claimDoubt('${doubt._id}', '${escapedQuestion}')" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                                <i class="fas fa-hand-paper mr-1"></i> Claim
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load new doubts.</td></tr>';
                badge.classList.add('hidden');
                badgeCount.classList.add('hidden');
            }
        }

        async function loadMyActiveDoubts() {
            const tbody = document.getElementById('myDoubtsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4" data-label="Loading"><div class="loading-skeleton h-8 w-full"></div></td></tr>';
            
            const data = await makeMentorAPICall('/doubts/active');
            tbody.innerHTML = '';
            
            if (data?.success && data.doubts) {
                if (data.doubts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400" data-label="Result">You have no active doubts assigned.</td></tr>';
                    return;
                }
                
                data.doubts.forEach(doubt => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" data-label="User">${doubt.userId.username}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Subject">${doubt.subject} (${doubt.topicId})</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300 truncate" data-label="Question" title="${doubt.initialQuestion}">${doubt.initialQuestion}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" data-label="Last Activity">${formatRelativeTime(doubt.updatedAt)}</td>
                        <td class="px-6 py-4 text-sm font-medium actions-cell" data-label="Actions">
                            <button onclick="openDoubtChatModal('${doubt._id}')" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background-color: #059669; hover:bg-green-700">
                                <i class="fas fa-comments mr-1"></i> Open
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500 dark:text-red-400" data-label="Error">Failed to load your active doubts.</td></tr>';
            }
        }

        async function claimDoubt(threadId, question) {
            if (!confirm(`Claim this doubt?\n\n"${question}"`)) {
                return;
            }
            showGlobalAlert('Claiming doubt...', 'info');
            const result = await makeMentorAPICall(`/doubts/claim/${threadId}`, { method: 'POST' });
            
            if (result?.success) {
                showGlobalAlert(result.message, 'success');
                // Switch to "My Active Doubts" tab and open the chat
                document.querySelector('.tab-button[data-tab="my-doubts-tab"]').click();
                loadDoubtsQueue(); // Refresh queue
                loadMyActiveDoubts(); // Refresh active list
                openDoubtChatModal(threadId); // Open the chat modal
            }
        }

        function closeDoubtChatModal() {
            document.getElementById('doubtChatModal').classList.remove('show');
            document.getElementById('currentChatThreadId').value = '';
            // Refresh lists in case status changed
            loadDoubtsQueue();
            loadMyActiveDoubts();
        }

        async function openDoubtChatModal(threadId) {
            const modal = document.getElementById('doubtChatModal');
            const loadingDiv = document.getElementById('doubtChatLoading');
            const errorDiv = document.getElementById('doubtChatError');
            const chatArea = document.getElementById('doubtChatArea');
            const messagesContainer = document.getElementById('doubtChatMessages');
            
            document.getElementById('currentChatThreadId').value = threadId;
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            chatArea.classList.add('hidden');
            messagesContainer.innerHTML = '';
            modal.classList.add('show');
            
            const data = await makeMentorAPICall(`/doubts/thread/${threadId}`);
            
            loadingDiv.classList.add('hidden');
            if (data?.success && data.thread && data.messages) {
                document.getElementById('doubtChatModalTitle').textContent = `Chat with ${data.messages[0]?.senderId ? data.messages[0].senderId.username : 'Unknown User'}`;
                renderMessages(data.messages);
                chatArea.classList.remove('hidden');
                document.getElementById('doubtReplyMessage').value = '';
                
                // Set resolve button status
                const resolveBtn = document.getElementById('resolveDoubtBtn');
                if (data.thread.status === 'resolved') {
                    resolveBtn.disabled = true;
                    resolveBtn.textContent = 'Resolved';
                } else {
                    resolveBtn.disabled = false;
                    resolveBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Resolved';
                }
            } else {
                errorDiv.textContent = 'Error loading conversation.';
                errorDiv.classList.remove('hidden');
            }
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('doubtChatMessages');
            messagesContainer.innerHTML = '';
            const myUserId = JSON.parse(localStorage.getItem('currentUser')).id;
            
            messages.forEach(msg => {
                const isMentor = msg.senderRole === 'mentor';
                
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${isMentor ? 'mentor' : 'user'}`;
                
                msgDiv.innerHTML = `
                    <div class="message-sender">${msg.senderId ? msg.senderId.username : 'Unknown User'} (${formatRelativeTime(msg.createdAt)})</div>
                    <div class="message-bubble">${msg.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                `;
                messagesContainer.appendChild(msgDiv);
            });
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendDoubtReply() {
            const threadId = document.getElementById('currentChatThreadId').value;
            const messageInput = document.getElementById('doubtReplyMessage');
            const sendBtn = document.getElementById('sendDoubtReplyBtn');
            const message = messageInput.value.trim();
            
            if (!message || !threadId) return;
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const data = await makeMentorAPICall(`/doubts/thread/${threadId}/reply`, {
                method: 'POST',
                body: JSON.stringify({ message })
            });
            
            if (data?.success && data.newMessage) {
                messageInput.value = ''; // Clear input
                // Add the new message to the UI
                const messagesContainer = document.getElementById('doubtChatMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message mentor`; // It's always the mentor replying here
                msgDiv.innerHTML = `
                    <div class="message-sender">${data.newMessage.senderId?.username || 'Mentor'} (just now)</div>
                    <div class="message-bubble">${data.newMessage.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                `;
                messagesContainer.appendChild(msgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
            } else {
                showGlobalAlert(data.message || 'Failed to send reply.', 'error');
            }
            
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }

        async function resolveDoubtThread() {
            const threadId = document.getElementById('currentChatThreadId').value;
            if (!threadId) return;
            
            if (!confirm('Are you sure you want to resolve this thread?\nThe user can reopen it by replying. The thread will be deleted 24 hours after resolution.')) {
                return;
            }
            
            const resolveBtn = document.getElementById('resolveDoubtBtn');
            resolveBtn.disabled = true;
            resolveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resolving...';
            
            const data = await makeMentorAPICall(`/doubts/thread/${threadId}/resolve`, {
                method: 'POST'
            });
            
            if (data?.success) {
                showGlobalAlert(data.message, 'success');
                resolveBtn.textContent = 'Resolved'; // Keep it disabled
                closeDoubtChatModal(); // Close modal on success
            } else {
                showGlobalAlert(data.message || 'Failed to resolve thread.', 'error');
                resolveBtn.disabled = false;
                resolveBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Resolved';
            }
        }

        // --- DOMContentLoaded (Modified) ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkMentorAuth()) return;

            // --- Your Existing Listeners ---
            document.getElementById('mentorLogoutBtn').addEventListener('click', mentorLogout);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', closeMobileMenu);
            document.getElementById('saveTestBtn').addEventListener('click', saveNewTest);
            document.getElementById('createTestModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeCreateTestModal(); });
            document.getElementById('saveQuestionBtn').addEventListener('click', saveNewQuestion);
            document.getElementById('addQuestionModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeAddQuestionModal(); });
            setupQuestionTypeToggle();
            document.getElementById('loadLeaderboardBtn').addEventListener('click', loadLeaderboard);
            document.getElementById('monitorTestSelect').addEventListener('change', loadTestAttempts);
            document.getElementById('refreshMonitorBtn').addEventListener('click', loadTestAttempts);

            // --- *** ADD THESE NEW LISTENERS *** ---
            document.getElementById('saveDailyProblemBtn').addEventListener('click', saveDailyProblem);
            document.getElementById('createDailyProblemModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeCreateDailyProblemModal();
            });
            document.getElementById('saveFeedbackBtn').addEventListener('click', saveFeedback);
            document.getElementById('reviewSubmissionModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeReviewSubmissionModal();
            });
            setupTabListeners(); // For the new "Doubts" section tabs
            document.getElementById('doubtChatModal').addEventListener('click', (e) => {
                if (e.target.id === 'doubtChatModal') closeDoubtChatModal();
            });
            // --- *** END NEW LISTENERS *** ---

            // Initial Navigation
            window.addEventListener('hashchange', handleNavigation);
            handleNavigation();
        });

        window.addEventListener('pageshow', function (event) {
            if (!checkMentorAuth()) {
                console.error("MENTOR PAGE: Auth check FAILED on pageshow.");
            }
        });
    </script>
</body>

</html>
